Description: Sagemaker Hyperpod Observability Stack
Transform: AWS::LanguageExtensions
Parameters:
  ResourceNamePrefix:
    Type: String
    Default: sagemaker-hyperpod-eks
    Description: Prefix to be used for all resources created by this template.
  EKSClusterName:
    Type: String
    Default: eks
    Description: The name of the EKS cluster.
  CustomResourceS3Bucket:
    Type: String
    Default: aws-sagemaker-hyperpod-cluster-setup-us-east-2-prod
    Description: The name of the S3 bucket containing the custom resource.
  GrafanaCustomResourceFunctionS3Key:
    Type: String
    Default: resources/artifacts/grafana-lambda-function.zip
    Description: The S3 key for the lambda function zip file.
  GrafanaCreatorfunctionS3Key:
    Type: String
    Default: resources/artifacts/observability-grafana-lambda-function.zip
    Description: The S3 key for the lambda function zip file.
  GrafanaServiceAccountfunctionS3Key:
    Type: String
    Default: resources/artifacts/grafana-service-token-lambda-function.zip
    Description: The S3 key for the lambda function zip file.
  CreateHyperPodObservabilityRole:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Specify whether to create new role for Hyperpod Observability AddOn
  HyperPodObservabilityRole:
    Type: String
    Default: ''
    Description: The role to be used with Hyperpod Observability AddOn
  CreateGrafanaRole:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Specify whether to create new role for Hyperpod Observability Grafana Custom Resources
  GrafanaRole:
    Type: String
    Default: ''
    Description: The role to be used with Hyperpod Observability Grafana Custom Resources
  CreatePrometheusWorkspace:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Specify whether to create new prometheus workspace
  PrometheusWorkspaceId:
    Type: String
    Default: ''
    Description: The ID of the existing Amazon Managed Service for Prometheus (AMP) workspace.
  PrometheusWorkspaceArn:
    Type: String
    Default: ''
    Description: The ARN of the existing Amazon Managed Service for Prometheus (AMP) workspace.
  PrometheusWorkspaceEndpoint:
    Type: String
    Default: ''
    Description: The Endpoint of the existing Amazon Managed Service for Prometheus (AMP) workspace.
  CreateGrafanaWorkspace:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
      - disabled
    Description: Specify whether to create new grafana workspace
  GrafanaWorkspaceId:
    Type: String
    Default: ''
    Description: The ID of the existing Amazon Managed Service for Grafana (AMG) workspace.
  GrafanaWorkspaceName:
    Type: String
    Default: ''
    Description: The Name of the existing Amazon Managed Service for Grafana (AMG) workspace.
  GrafanaWorkspaceArn:
    Type: String
    Default: ''
    Description: The Arn of the existing Amazon Managed Service for Grafana (AMG) workspace.
  TrainingMetricLevel:
    Type: String
    Default: BASIC
    Description: The level of training metric for EKS AddOn.
  TaskGovernanceMetricLevel:
    Type: String
    Default: DISABLED
    Description: The level of task governance metric for EKS AddOn.
  ScalingMetricLevel:
    Type: String
    Default: DISABLED
    Description: The level of scaling metric for EKS AddOn.
  ClusterMetricLevel:
    Type: String
    Default: BASIC
    Description: The level of cluster metric for EKS AddOn.
  NodeMetricLevel:
    Type: String
    Default: BASIC
    Description: The level of node metric for EKS AddOn.
  NetworkMetricLevel:
    Type: String
    Default: DISABLED
    Description: The level of network metric for EKS AddOn.
  AcceleratedComputeMetricLevel:
    Type: String
    Default: BASIC
    Description: The level of accelerated compute metric for EKS AddOn.
  Logging:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Specify whether to enable logging
  VpcId:
    Type: String
    Default: vpc-1234567890abcdef0
    Description: The ID of the VPC where endpoints will be created
  SecurityGroupId:
    Type: String
    Default: ''
    Description: The security of the VPC
  PrivateSubnetIds:
    Type: CommaDelimitedList
    Default: subnet-1234567890abcdef0,subnet-1234567890abcdef1
    Description: List of private subnet IDs for VPC endpoints
Mappings:
  AMGRegionMapping:
    us-east-1:
      isAllowed: 'true'
    us-east-2:
      isAllowed: 'true'
    us-west-2:
      isAllowed: 'true'
    ap-northeast-1:
      isAllowed: 'true'
    ap-northeast-2:
      isAllowed: 'true'
    ap-southeast-1:
      isAllowed: 'true'
    ap-southeast-2:
      isAllowed: 'true'
    ca-central-1:
      isAllowed: 'true'
    eu-central-1:
      isAllowed: 'true'
    eu-west-1:
      isAllowed: 'true'
    eu-west-2:
      isAllowed: 'true'
Conditions:
  IsAmgAllowed:
    Fn::And:
      - Fn::Equals:
          - Fn::FindInMap:
              - AMGRegionMapping
              - Ref: AWS::Region
              - isAllowed
              - DefaultValue: 'false'
          - 'true'
      - Fn::Not:
          - Fn::Equals:
              - Ref: CreateGrafanaWorkspace
              - disabled
  PrometheusNewWorkspaceCondition:
    Fn::Equals:
      - Ref: CreatePrometheusWorkspace
      - 'true'
  GrafanaNewWorkspaceCondition:
    Fn::Equals:
      - Ref: CreateGrafanaWorkspace
      - 'true'
  EnableLoggingCondition:
    Fn::Equals:
      - Ref: Logging
      - 'true'
  EksAddOnWithAmgWithLoggingCondition:
    Fn::And:
      - Condition: EnableLoggingCondition
      - Condition: IsAmgAllowed
  EksAddOnWithoutAmgWithLoggingCondition:
    Fn::And:
      - Condition: EnableLoggingCondition
      - Fn::Not:
          - Condition: IsAmgAllowed
  EksAddOnWithAmgWithoutLoggingCondition:
    Fn::And:
      - Fn::Not:
          - Condition: EnableLoggingCondition
      - Condition: IsAmgAllowed
  EksAddOnWithoutAmgWithoutLoggingCondition:
    Fn::And:
      - Fn::Not:
          - Condition: EnableLoggingCondition
      - Fn::Not:
          - Condition: IsAmgAllowed
  CreateHyperPodObservabilityRoleCondition:
    Fn::Equals:
      - Ref: CreateHyperPodObservabilityRole
      - 'true'
  CreateGrafanaRoleCondition:
    Fn::And:
      - Fn::Equals:
          - Ref: CreateGrafanaRole
          - 'true'
      - Condition: IsAmgAllowed
Resources:
  GrafanaVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - Ref: SecurityGroupId
      ServiceName:
        Fn::Sub: com.amazonaws.${AWS::Region}.grafana-workspace
      SubnetIds:
        Fn::Split:
          - ','
          - Fn::Join:
              - ','
              - Ref: PrivateSubnetIds
      Tags:
        - Key: Name
          Value:
            Fn::Sub: ${ResourceNamePrefix}-gVpce
      VpcEndpointType: Interface
      VpcId:
        Ref: VpcId
    Metadata:
      aws:cdk:path: ObservabilityCfnTemplate/GrafanaVPCEndpoint
    Condition: IsAmgAllowed
  PrometheusVPCEndpoint:
    Type: AWS::EC2::VPCEndpoint
    Properties:
      PrivateDnsEnabled: true
      SecurityGroupIds:
        - Ref: SecurityGroupId
      ServiceName:
        Fn::Sub: com.amazonaws.${AWS::Region}.aps-workspaces
      SubnetIds:
        Fn::Split:
          - ','
          - Fn::Join:
              - ','
              - Ref: PrivateSubnetIds
      Tags:
        - Key: Name
          Value:
            Fn::Sub: ${ResourceNamePrefix}-pVpce
      VpcEndpointType: Interface
      VpcId:
        Ref: VpcId
    Metadata:
      aws:cdk:path: ObservabilityCfnTemplate/PrometheusVPCEndpoint
  PrometheusWorkspace:
    Type: AWS::APS::Workspace
    Properties:
      Alias:
        Fn::Join:
          - '-'
          - - Fn::Sub: ${ResourceNamePrefix}
            - ampws
      Tags:
        - Key: SageMaker
          Value: 'true'
    UpdateReplacePolicy: Retain
    DeletionPolicy: Retain
    Metadata:
      aws:cdk:path: ObservabilityCfnTemplate/PrometheusWorkspace
    Condition: PrometheusNewWorkspaceCondition
  HyperPodObservabilityAddonRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: AllowEksAuthToAssumeRoleForPodIdentity
            Effect: Allow
            Principal:
              Service: pods.eks.amazonaws.com
            Action:
              - sts:AssumeRole
              - sts:TagSession
            Condition:
              StringEquals:
                aws:SourceAccount:
                  Fn::Sub: ${AWS::AccountId}
                aws:SourceArn:
                  Fn::Sub: arn:aws:eks:${AWS::Region}:${AWS::AccountId}:cluster/${EKSClusterName}
      MaxSessionDuration: 3600
      Path: /service-role/
      Policies:
        - PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Sid: PrometheusAccess
                Effect: Allow
                Action:
                  - aps:RemoteWrite
                Resource:
                  Fn::Sub: arn:aws:aps:${AWS::Region}:${AWS::AccountId}:workspace/*
              - Sid: CloudwatchLogsAccess
                Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:DescribeLogGroups
                  - logs:DescribeLogStreams
                  - logs:PutLogEvents
                  - logs:GetLogEvents
                  - logs:FilterLogEvents
                  - logs:GetLogRecord
                  - logs:StartQuery
                  - logs:StopQuery
                  - logs:GetQueryResults
                Resource:
                  - Fn::Sub: arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/sagemaker/Clusters/*
                  - Fn::Sub: arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/sagemaker/Clusters/*:log-stream:*
          PolicyName:
            Fn::Sub: ${ResourceNamePrefix}-OnPol
      RoleName:
        Fn::Sub: ${ResourceNamePrefix}-AddOn
    Metadata:
      aws:cdk:path: ObservabilityCfnTemplate/HyperPodObservabilityAddonRole
    Condition: CreateHyperPodObservabilityRoleCondition
  GrafanaWorkspaceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: GrafanaAssumeRole
            Effect: Allow
            Principal:
              Service: grafana.amazonaws.com
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                aws:SourceAccount:
                  Fn::Sub: ${AWS::AccountId}
      Path: /service-role/
      Policies:
        - PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Sid: AllowReadingMetricsFromCloudWatch
                Effect: Allow
                Action:
                  - cloudwatch:ListMetrics
                  - cloudwatch:GetMetricStatistics
                  - cloudwatch:GetMetricData
                  - cloudwatch:DescribeAlarmsForMetric
                  - cloudwatch:GetInsightRuleReport
                Resource: '*'
              - Sid: AllowReadingAlarmsFromCloudWatch
                Effect: Allow
                Action:
                  - cloudwatch:DescribeAlarmHistory
                  - cloudwatch:DescribeAlarms
                Resource: arn:aws:cloudwatch:*:*:alarm:*
              - Sid: AllowReadingLogsFromCloudWatch
                Effect: Allow
                Action:
                  - logs:DescribeLogGroups
                  - logs:StopQuery
                  - logs:GetLogEvents
                Resource: '*'
              - Sid: AllowQueryLogsFromCloudWatch
                Effect: Allow
                Action:
                  - logs:GetLogGroupFields
                  - logs:StartQuery
                  - logs:GetQueryResults
                  - logs:GetLogEvents
                Resource:
                  - arn:aws:logs:*:*:log-group:*
                  - arn:aws:logs:*:*:log-group:*:log-stream:*
              - Sid: AllowReadingTagsInstancesRegionsFromEC2
                Effect: Allow
                Action:
                  - ec2:DescribeTags
                  - ec2:DescribeInstances
                  - ec2:DescribeRegions
                Resource: '*'
              - Sid: AllowReadingResourcesForTags
                Effect: Allow
                Action: tag:GetResources
                Resource: '*'
              - Sid: AllowListWorkspacesFromPrometheus
                Effect: Allow
                Action:
                  - aps:ListWorkspaces
                Resource: '*'
              - Sid: AllowReadingMetricsFromPrometheus
                Effect: Allow
                Action:
                  - aps:DescribeWorkspace
                  - aps:QueryMetrics
                  - aps:GetLabels
                  - aps:GetSeries
                  - aps:GetMetricMetadata
                Resource: arn:aws:aps:*:*:workspace/*
              - Sid: AllowReadingAlertsFromPrometheus
                Effect: Allow
                Action:
                  - aps:ListRules
                  - aps:ListAlertManagerSilences
                  - aps:ListAlertManagerAlerts
                  - aps:GetAlertManagerStatus
                  - aps:ListAlertManagerAlertGroups
                  - aps:PutAlertManagerSilences
                  - aps:DeleteAlertManagerSilence
                Resource: arn:aws:aps:*:*:workspace/*
          PolicyName:
            Fn::Sub: ${ResourceNamePrefix}-GraPol
      RoleName:
        Fn::Sub: ${ResourceNamePrefix}-GraAcc
    Metadata:
      aws:cdk:path: ObservabilityCfnTemplate/GrafanaWorkspaceRole
    Condition: CreateGrafanaRoleCondition
  GrafanaWorkspaceCustomResourceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonSageMakerHyperPodObservabilityAdminAccess
      Policies:
        - PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource:
                  Fn::GetAtt:
                    - GrafanaWorkspaceRole
                    - Arn
          PolicyName:
            Fn::Sub: ${ResourceNamePrefix}-AMGIAM
        - PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - ec2:GetManagedPrefixListEntries
                  - kms:Decrypt
                Resource:
                  - Fn::Sub: arn:${AWS::Partition}:ec2:*:${AWS::AccountId}:prefix-list/*
                  - Fn::Sub: arn:${AWS::Partition}:kms:*:${AWS::AccountId}:key/*
          PolicyName:
            Fn::Sub: ${ResourceNamePrefix}-AMGWSEC2
        - PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - sso:DescribeRegisteredRegions
                  - sso:GetSharedSsoConfiguration
                  - ec2:DescribeSubnets
                  - ec2:DescribeSubnetGroups
                  - organizations:DescribeOrganization
                Resource:
                  - '*'
          PolicyName:
            Fn::Sub: ${ResourceNamePrefix}-AMGWS
        - PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - iam:CreateServiceLinkedRole
                Resource:
                  - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/*
          PolicyName:
            Fn::Sub: ${ResourceNamePrefix}-AMGWSSLR
      RoleName:
        Fn::Sub: ${ResourceNamePrefix}-AMGWS
    Metadata:
      aws:cdk:path: ObservabilityCfnTemplate/GrafanaWorkspaceCustomResourceRole
    Condition: IsAmgAllowed
  GrafanaWorkspaceCustomResourceFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: CustomResourceS3Bucket
        S3Key:
          Ref: GrafanaCreatorfunctionS3Key
      Environment:
        Variables:
          WORKSPACE_NAME:
            Fn::Join:
              - '-'
              - - Fn::Sub: ${ResourceNamePrefix}
                - amgws
          WORKSPACE_ROLE_ARN:
            Fn::If:
              - CreateGrafanaRoleCondition
              - Fn::GetAtt:
                  - GrafanaWorkspaceRole
                  - Arn
              - Ref: GrafanaRole
          REGION:
            Fn::Sub: ${AWS::Region}
          AWS_ACCOUNT_ID:
            Fn::Sub: ${AWS::AccountId}
          PARTITION:
            Fn::Sub: ${AWS::Partition}
      FunctionName:
        Fn::Sub: ${ResourceNamePrefix}-grafana-creation-func
      Handler: lambda_function.lambda_handler
      MemorySize: 2048
      Role:
        Fn::GetAtt:
          - GrafanaWorkspaceCustomResourceRole
          - Arn
      Runtime: python3.12
      Tags:
        - Key: SageMaker
          Value: 'true'
      Timeout: 900
    Metadata:
      aws:cdk:path: ObservabilityCfnTemplate/GrafanaWorkspaceCustomResourceFunction
    Condition: IsAmgAllowed
  GrafanaWorkspaceCustomResource:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - GrafanaWorkspaceCustomResourceFunction
          - Arn
    Metadata:
      aws:cdk:path: ObservabilityCfnTemplate/GrafanaWorkspaceCustomResource
    Condition: IsAmgAllowed
  EksAddOnWithAmgWithLogging:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: amazon-sagemaker-hyperpod-observability
      ClusterName:
        Ref: EKSClusterName
      ConfigurationValues:
        Fn::Join:
          - ''
          - - '{"ampWorkspace":{"prometheusEndpoint":"https://aps-workspaces.'
            - Fn::Sub: ${AWS::Region}
            - .amazonaws.com/workspaces/
            - Fn::GetAtt:
                - PrometheusWorkspace
                - WorkspaceId
            - '","arn":"'
            - Fn::If:
                - PrometheusNewWorkspaceCondition
                - Fn::GetAtt:
                    - PrometheusWorkspace
                    - Arn
                - Ref: PrometheusWorkspaceArn
            - '"},"metricsProvider":{"trainingMetrics":{"level":"'
            - Ref: TrainingMetricLevel
            - >-
              ","scrapeInterval":30},"inferenceMetrics":{"level":"BASIC","scrapeInterval":30},"taskGovernanceMetrics":{"level":"
            - Ref: TaskGovernanceMetricLevel
            - '","scrapeInterval":30},"scalingMetrics":{"level":"'
            - Ref: ScalingMetricLevel
            - '","scrapeInterval":30},"customMetrics":{"level":"'
            - Ref: ClusterMetricLevel
            - '","scrapeInterval":30},"nodeMetrics":{"level":"'
            - Ref: NodeMetricLevel
            - '","scrapeInterval":30},"acceleratedComputeMetrics":{"level":"'
            - Ref: AcceleratedComputeMetricLevel
            - '","scrapeInterval":30},"networkMetrics":{"level":"'
            - Ref: NetworkMetricLevel
            - '","scrapeInterval":30}},"amgWorkspace":{"workspaceName":"'
            - Fn::If:
                - GrafanaNewWorkspaceCondition
                - Fn::GetAtt:
                    - GrafanaWorkspaceCustomResource
                    - Name
                - Ref: GrafanaWorkspaceName
            - '","arn":"'
            - Fn::If:
                - GrafanaNewWorkspaceCondition
                - Fn::GetAtt:
                    - GrafanaWorkspaceCustomResource
                    - Arn
                - Ref: GrafanaWorkspaceArn
            - '"},"logging":{"enabled":true}}'
      PodIdentityAssociations:
        - RoleArn:
            Fn::If:
              - CreateHyperPodObservabilityRoleCondition
              - Fn::GetAtt:
                  - HyperPodObservabilityAddonRole
                  - Arn
              - Ref: HyperPodObservabilityRole
          ServiceAccount: hyperpod-observability-operator-otel-collector
      ResolveConflicts: OVERWRITE
      Tags:
        - Key: SageMaker
          Value: 'true'
    Metadata:
      aws:cdk:path: ObservabilityCfnTemplate/EksAddOnWithAmgWithLogging
    Condition: EksAddOnWithAmgWithLoggingCondition
  EksAddOnWithAmgWithoutLogging:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: amazon-sagemaker-hyperpod-observability
      ClusterName:
        Ref: EKSClusterName
      ConfigurationValues:
        Fn::Join:
          - ''
          - - '{"ampWorkspace":{"prometheusEndpoint":"https://aps-workspaces.'
            - Fn::Sub: ${AWS::Region}
            - .amazonaws.com/workspaces/
            - Fn::GetAtt:
                - PrometheusWorkspace
                - WorkspaceId
            - '","arn":"'
            - Fn::If:
                - PrometheusNewWorkspaceCondition
                - Fn::GetAtt:
                    - PrometheusWorkspace
                    - Arn
                - Ref: PrometheusWorkspaceArn
            - '"},"metricsProvider":{"trainingMetrics":{"level":"'
            - Ref: TrainingMetricLevel
            - >-
              ","scrapeInterval":30},"inferenceMetrics":{"level":"BASIC","scrapeInterval":30},"taskGovernanceMetrics":{"level":"
            - Ref: TaskGovernanceMetricLevel
            - '","scrapeInterval":30},"scalingMetrics":{"level":"'
            - Ref: ScalingMetricLevel
            - '","scrapeInterval":30},"customMetrics":{"level":"'
            - Ref: ClusterMetricLevel
            - '","scrapeInterval":30},"nodeMetrics":{"level":"'
            - Ref: NodeMetricLevel
            - '","scrapeInterval":30},"acceleratedComputeMetrics":{"level":"'
            - Ref: AcceleratedComputeMetricLevel
            - '","scrapeInterval":30},"networkMetrics":{"level":"'
            - Ref: NetworkMetricLevel
            - '","scrapeInterval":30}},"amgWorkspace":{"workspaceName":"'
            - Fn::If:
                - GrafanaNewWorkspaceCondition
                - Fn::GetAtt:
                    - GrafanaWorkspaceCustomResource
                    - Name
                - Ref: GrafanaWorkspaceName
            - '","arn":"'
            - Fn::If:
                - GrafanaNewWorkspaceCondition
                - Fn::GetAtt:
                    - GrafanaWorkspaceCustomResource
                    - Arn
                - Ref: GrafanaWorkspaceArn
            - '"},"logging":{"enabled":false}}'
      PodIdentityAssociations:
        - RoleArn:
            Fn::If:
              - CreateHyperPodObservabilityRoleCondition
              - Fn::GetAtt:
                  - HyperPodObservabilityAddonRole
                  - Arn
              - Ref: HyperPodObservabilityRole
          ServiceAccount: hyperpod-observability-operator-otel-collector
      ResolveConflicts: OVERWRITE
      Tags:
        - Key: SageMaker
          Value: 'true'
    Metadata:
      aws:cdk:path: ObservabilityCfnTemplate/EksAddOnWithAmgWithoutLogging
    Condition: EksAddOnWithAmgWithoutLoggingCondition
  EksAddOnWithoutAmgWithLogging:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: amazon-sagemaker-hyperpod-observability
      ClusterName:
        Ref: EKSClusterName
      ConfigurationValues:
        Fn::Join:
          - ''
          - - '{"ampWorkspace":{"prometheusEndpoint":"https://aps-workspaces.'
            - Fn::Sub: ${AWS::Region}
            - .amazonaws.com/workspaces/
            - Fn::GetAtt:
                - PrometheusWorkspace
                - WorkspaceId
            - '","arn":"'
            - Fn::If:
                - PrometheusNewWorkspaceCondition
                - Fn::GetAtt:
                    - PrometheusWorkspace
                    - Arn
                - Ref: PrometheusWorkspaceArn
            - '"},"metricsProvider":{"trainingMetrics":{"level":"'
            - Ref: TrainingMetricLevel
            - >-
              ","scrapeInterval":30},"inferenceMetrics":{"level":"BASIC","scrapeInterval":30},"taskGovernanceMetrics":{"level":"
            - Ref: TaskGovernanceMetricLevel
            - '","scrapeInterval":30},"scalingMetrics":{"level":"'
            - Ref: ScalingMetricLevel
            - '","scrapeInterval":30},"customMetrics":{"level":"'
            - Ref: ClusterMetricLevel
            - '","scrapeInterval":30},"nodeMetrics":{"level":"'
            - Ref: NodeMetricLevel
            - '","scrapeInterval":30},"acceleratedComputeMetrics":{"level":"'
            - Ref: AcceleratedComputeMetricLevel
            - '","scrapeInterval":30},"networkMetrics":{"level":"'
            - Ref: NetworkMetricLevel
            - '","scrapeInterval":30}},"logging":{"enabled":true}}'
      PodIdentityAssociations:
        - RoleArn:
            Fn::If:
              - CreateHyperPodObservabilityRoleCondition
              - Fn::GetAtt:
                  - HyperPodObservabilityAddonRole
                  - Arn
              - Ref: HyperPodObservabilityRole
          ServiceAccount: hyperpod-observability-operator-otel-collector
      ResolveConflicts: OVERWRITE
      Tags:
        - Key: SageMaker
          Value: 'true'
    Metadata:
      aws:cdk:path: ObservabilityCfnTemplate/EksAddOnWithoutAmgWithLogging
    Condition: EksAddOnWithoutAmgWithLoggingCondition
  EksAddOnWithoutAmgWithoutLogging:
    Type: AWS::EKS::Addon
    Properties:
      AddonName: amazon-sagemaker-hyperpod-observability
      ClusterName:
        Ref: EKSClusterName
      ConfigurationValues:
        Fn::Join:
          - ''
          - - '{"ampWorkspace":{"prometheusEndpoint":"https://aps-workspaces.'
            - Fn::Sub: ${AWS::Region}
            - .amazonaws.com/workspaces/
            - Fn::GetAtt:
                - PrometheusWorkspace
                - WorkspaceId
            - '","arn":"'
            - Fn::If:
                - PrometheusNewWorkspaceCondition
                - Fn::GetAtt:
                    - PrometheusWorkspace
                    - Arn
                - Ref: PrometheusWorkspaceArn
            - '"},"metricsProvider":{"trainingMetrics":{"level":"'
            - Ref: TrainingMetricLevel
            - >-
              ","scrapeInterval":30},"inferenceMetrics":{"level":"BASIC","scrapeInterval":30},"taskGovernanceMetrics":{"level":"
            - Ref: TaskGovernanceMetricLevel
            - '","scrapeInterval":30},"scalingMetrics":{"level":"'
            - Ref: ScalingMetricLevel
            - '","scrapeInterval":30},"customMetrics":{"level":"'
            - Ref: ClusterMetricLevel
            - '","scrapeInterval":30},"nodeMetrics":{"level":"'
            - Ref: NodeMetricLevel
            - '","scrapeInterval":30},"acceleratedComputeMetrics":{"level":"'
            - Ref: AcceleratedComputeMetricLevel
            - '","scrapeInterval":30},"networkMetrics":{"level":"'
            - Ref: NetworkMetricLevel
            - '","scrapeInterval":30}},"logging":{"enabled":false}}'
      PodIdentityAssociations:
        - RoleArn:
            Fn::If:
              - CreateHyperPodObservabilityRoleCondition
              - Fn::GetAtt:
                  - HyperPodObservabilityAddonRole
                  - Arn
              - Ref: HyperPodObservabilityRole
          ServiceAccount: hyperpod-observability-operator-otel-collector
      ResolveConflicts: OVERWRITE
      Tags:
        - Key: SageMaker
          Value: 'true'
    Metadata:
      aws:cdk:path: ObservabilityCfnTemplate/EksAddOnWithoutAmgWithoutLogging
    Condition: EksAddOnWithoutAmgWithoutLoggingCondition
  GrafanaServiceAccountLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonSageMakerHyperPodObservabilityAdminAccess
      RoleName:
        Fn::Sub: ${ResourceNamePrefix}-SA
    Metadata:
      aws:cdk:path: ObservabilityCfnTemplate/GrafanaServiceAccountLambdaRole
    Condition: IsAmgAllowed
  GrafanaServiceAccountLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: CustomResourceS3Bucket
        S3Key:
          Ref: GrafanaServiceAccountfunctionS3Key
      Environment:
        Variables:
          GRAFANA_WORKSPACE_ID:
            Fn::If:
              - GrafanaNewWorkspaceCondition
              - Fn::GetAtt:
                  - GrafanaWorkspaceCustomResource
                  - WorkspaceId
              - Ref: GrafanaWorkspaceId
          REGION:
            Fn::Sub: ${AWS::Region}
          SERVICE_ACCOUNT_NAME:
            Fn::Sub: ${ResourceNamePrefix}-SA
      FunctionName:
        Fn::Sub: ${ResourceNamePrefix}-SAfunction
      Handler: lambda_function.lambda_handler
      MemorySize: 2048
      Role:
        Fn::GetAtt:
          - GrafanaServiceAccountLambdaRole
          - Arn
      Runtime: python3.12
      Tags:
        - Key: SageMaker
          Value: 'true'
      Timeout: 900
    Metadata:
      aws:cdk:path: ObservabilityCfnTemplate/GrafanaServiceAccountLambdaFunction
    Condition: IsAmgAllowed
  GrafanaServiceAccountCustomResource:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - GrafanaServiceAccountLambdaFunction
          - Arn
    DependsOn:
      - GrafanaWorkspaceCustomResource
    Metadata:
      aws:cdk:path: ObservabilityCfnTemplate/GrafanaServiceAccountCustomResource
    Condition: IsAmgAllowed
  GrafanaCustomResourceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - ec2:CreateNetworkInterface
                  - ec2:CreateTags
                Resource:
                  - Fn::Sub: arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:security-group/*
                  - Fn::Sub: arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:subnet/*
                  - Fn::Sub: arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:network-interface/*
                  - Fn::Sub: arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:vpc/${VpcId}
              - Effect: Allow
                Action:
                  - ec2:DeleteNetworkInterface
                Resource:
                  - Fn::Sub: arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:*/*
              - Effect: Allow
                Action:
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DescribeVpcs
                  - ec2:DescribeSubnets
                  - ec2:DescribeSecurityGroups
                Resource: '*'
          PolicyName:
            Fn::Sub: ${ResourceNamePrefix}-AMGCR
      RoleName:
        Fn::Sub: ${ResourceNamePrefix}-AMGCR
    Metadata:
      aws:cdk:path: ObservabilityCfnTemplate/GrafanaCustomResourceRole
    Condition: IsAmgAllowed
  GrafanaCustomResourceFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: CustomResourceS3Bucket
        S3Key:
          Ref: GrafanaCustomResourceFunctionS3Key
      Environment:
        Variables:
          GRAFANA_WORKSPACE_ID:
            Fn::If:
              - GrafanaNewWorkspaceCondition
              - Fn::GetAtt:
                  - GrafanaWorkspaceCustomResource
                  - WorkspaceId
              - Ref: GrafanaWorkspaceId
          PROMETHEUS_WORKSPACE_ID:
            Fn::If:
              - PrometheusNewWorkspaceCondition
              - Fn::GetAtt:
                  - PrometheusWorkspace
                  - WorkspaceId
              - Ref: PrometheusWorkspaceId
          GRAFANA_WORKSPACE_TOKEN_KEY:
            Fn::GetAtt:
              - GrafanaServiceAccountCustomResource
              - ServiceAccountTokenKey
          REGION:
            Fn::Sub: ${AWS::Region}
      FunctionName:
        Fn::Sub: ${ResourceNamePrefix}-grafunc
      Handler: lambda_function.lambda_handler
      MemorySize: 2048
      Role:
        Fn::GetAtt:
          - GrafanaCustomResourceRole
          - Arn
      Runtime: python3.12
      Tags:
        - Key: SageMaker
          Value: 'true'
      Timeout: 900
      VpcConfig:
        SecurityGroupIds:
          - Ref: SecurityGroupId
        SubnetIds:
          Fn::Split:
            - ','
            - Fn::Join:
                - ','
                - Ref: PrivateSubnetIds
    DependsOn:
      - GrafanaServiceAccountCustomResource
    Metadata:
      aws:cdk:path: ObservabilityCfnTemplate/GrafanaCustomResourceFunction
    Condition: IsAmgAllowed
  GrafanaHttpCustomResources:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - GrafanaCustomResourceFunction
          - Arn
    Metadata:
      aws:cdk:path: ObservabilityCfnTemplate/GrafanaHttpCustomResources
    Condition: IsAmgAllowed
Outputs:
  ObservabilityRoleArn:
    Description: HyperPod Observability IAM Role ARN
    Value:
      Fn::If:
        - CreateHyperPodObservabilityRoleCondition
        - Fn::GetAtt:
            - HyperPodObservabilityAddonRole
            - Arn
        - Ref: HyperPodObservabilityRole
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-ObservabilityRoleArn
  GrafanaWorkspaceRoleArn:
    Description: HyperPod Observability Grafana IAM Role ARN
    Value:
      Fn::If:
        - CreateGrafanaRoleCondition
        - Fn::GetAtt:
            - GrafanaWorkspaceRole
            - Arn
        - Ref: GrafanaRole
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-GrafanaWorkspaceRoleArn
    Condition: IsAmgAllowed
  GrafanaVPCEndpointId:
    Description: Grafana VPC Endpoint ID
    Value:
      Ref: GrafanaVPCEndpoint
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-GrafanaVPCEndpointId
    Condition: IsAmgAllowed
  PrometheusVPCEndpointId:
    Description: Prometheus VPC Endpoint ID
    Value:
      Ref: PrometheusVPCEndpoint
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PrometheusVPCEndpointId
  HyperpodPrometheusWorkspaceId:
    Description: Prometheus Workspace ID
    Value:
      Fn::If:
        - PrometheusNewWorkspaceCondition
        - Fn::GetAtt:
            - PrometheusWorkspace
            - WorkspaceId
        - Ref: PrometheusWorkspaceId
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PrometheusWorkspaceId
  HyperpodPrometheusWorkspaceArn:
    Description: Prometheus Workspace Arn
    Value:
      Fn::If:
        - PrometheusNewWorkspaceCondition
        - Fn::GetAtt:
            - PrometheusWorkspace
            - Arn
        - Ref: PrometheusWorkspaceArn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PrometheusWorkspaceArn
  HyperpodPrometheusWorkspaceEndpoint:
    Description: Prometheus Workspace Endpoint
    Value:
      Fn::If:
        - PrometheusNewWorkspaceCondition
        - Fn::GetAtt:
            - PrometheusWorkspace
            - PrometheusEndpoint
        - Ref: PrometheusWorkspaceEndpoint
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-PrometheusWorkspaceEndpoint
  HyperpodGrafanaWorkspaceArn:
    Description: Grafana Workspace Arn
    Value:
      Fn::If:
        - GrafanaNewWorkspaceCondition
        - Fn::GetAtt:
            - GrafanaWorkspaceCustomResource
            - Arn
        - Ref: GrafanaWorkspaceArn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-GrafanaWorkspaceArn
    Condition: IsAmgAllowed
  HyperpodGrafanaWorkspaceId:
    Description: Grafana Workspace ID
    Value:
      Fn::If:
        - GrafanaNewWorkspaceCondition
        - Fn::GetAtt:
            - GrafanaWorkspaceCustomResource
            - WorkspaceId
        - Ref: GrafanaWorkspaceId
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-GrafanaWorkspaceId
    Condition: IsAmgAllowed
  HyperpodObservabilityAddOnArn:
    Description: Observability AddOn ARN
    Value:
      Fn::If:
        - IsAmgAllowed
        - Fn::If:
            - EnableLoggingCondition
            - Fn::GetAtt:
                - EksAddOnWithAmgWithLogging
                - Arn
            - Fn::GetAtt:
                - EksAddOnWithAmgWithoutLogging
                - Arn
        - Fn::If:
            - EnableLoggingCondition
            - Fn::GetAtt:
                - EksAddOnWithoutAmgWithLogging
                - Arn
            - Fn::GetAtt:
                - EksAddOnWithoutAmgWithoutLogging
                - Arn
    Export:
      Name:
        Fn::Sub: ${AWS::StackName}-AddOnArn
