Description: Tiered Storage Update Stack - KV Cache Configuration
Parameters:
  ResourceNamePrefix:
    Type: String
    Default: sagemaker-hyperpod-eks
    Description: Prefix to be used for all resources created by this template.
  EKSClusterName:
    Type: String
    Default: hyperpod-eks-cluster
    Description: The name of the EKS cluster.
  HyperPodClusterName:
    Type: String
    Default: ml-cluster
    Description: Name of SageMaker HyperPod Cluster.
  CustomResourceS3Bucket:
    Type: String
    Default: ws-assets-prod-iad-r-pdx-f3b3f9f1a7d6a3d0
    Description: The name of the S3 bucket containing the custom resource.
  LayerS3Key:
    Type: String
    Default: resources/artifacts/tiered-cache-lambda-layer.zip
    Description: The S3 key for the lambda layer zip file.
  FunctionS3Key:
    Type: String
    Default: resources/artifacts/tiered-cache-lambda-function.zip
    Description: The S3 key for the lambda function zip file.
  TieredStorageConfig:
    Type: String
    Default: ''
    Description: >-
      JSON string containing tiered storage configuration. Format: {"Mode": "Enable",
      "InstanceMemoryAllocationPercentage": 20}
  TieredKVCacheConfig:
    Type: String
    Default: ''
    Description: >-
      JSON string containing tiered KV cache configuration. Format: {"KVCacheMode": "Enable", "InstanceGroup": ["ig-1"],
      "NVMeMode": "Enable"}
  Region:
    Type: String
    Default: us-west-2
    Description: AWS Region
  Stage:
    Type: String
    Default: prod
    AllowedValues:
      - gamma
      - prod
    Description: Deployment stage (gamma, prod)
Conditions:
  IsGammaStage:
    Fn::Equals:
      - Ref: Stage
      - gamma
Resources:
  TieredCacheConfigCustomResourceLayer:
    Type: AWS::Lambda::LayerVersion
    Properties:
      CompatibleArchitectures:
        - x86_64
      CompatibleRuntimes:
        - python3.9
        - python3.10
        - python3.11
        - python3.12
      Content:
        S3Bucket:
          Ref: CustomResourceS3Bucket
        S3Key:
          Ref: LayerS3Key
      Description: Lambda Layer for kubectl and AWS CLI tools
      LayerName:
        Fn::Sub: ${ResourceNamePrefix}-tiered-cache-config-layer
    Metadata:
      aws:cdk:path: TieredCacheConfigCfnTemplate/TieredCacheConfigCustomResourceLayer
  TieredCacheConfigCustomResourceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - eks:DescribeCluster
                Resource:
                  Fn::Sub: arn:aws:eks:${AWS::Region}:${AWS::AccountId}:cluster/${EKSClusterName}
              - Effect: Allow
                Action:
                  - sagemaker:DescribeCluster
                  - sagemaker:ListClusterNodes
                Resource:
                  Fn::Sub: arn:aws:sagemaker:${AWS::Region}:${AWS::AccountId}:cluster/*
              - Effect: Allow
                Action:
                  - ec2:DescribeInstanceTypes
                Resource: '*'
              - Effect: Allow
                Action:
                  - ec2:CreateNetworkInterface
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DeleteNetworkInterface
                  - ec2:AssignPrivateIpAddresses
                  - ec2:UnassignPrivateIpAddresses
                Resource: '*'
          PolicyName:
            Fn::Sub: ${ResourceNamePrefix}-TieredCacheConfig-Policy
    Metadata:
      aws:cdk:path: TieredCacheConfigCfnTemplate/TieredCacheConfigCustomResourceRole
  TieredCacheConfigCustomResourceAccessEntry:
    Type: AWS::EKS::AccessEntry
    Properties:
      AccessPolicies:
        - AccessScope:
            Type: cluster
          PolicyArn: arn:aws:eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy
      ClusterName:
        Ref: EKSClusterName
      PrincipalArn:
        Fn::GetAtt:
          - TieredCacheConfigCustomResourceRole
          - Arn
    Metadata:
      aws:cdk:path: TieredCacheConfigCfnTemplate/TieredCacheConfigCustomResourceAccessEntry
  TieredCacheConfigCustomResourceFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: CustomResourceS3Bucket
        S3Key:
          Ref: FunctionS3Key
      Environment:
        Variables:
          CLUSTER_NAME:
            Ref: EKSClusterName
          HYPERPOD_CLUSTER_NAME:
            Ref: HyperPodClusterName
          REGION:
            Ref: Region
          TIERED_STORAGE_CONFIG:
            Ref: TieredStorageConfig
          TIERED_KV_CACHE_CONFIG:
            Ref: TieredKVCacheConfig
          KV_CACHE_MEMORY_PERCENTAGE: '20'
          KV_CACHE_MEMORY_BUFFER_GB: '1'
          NVME_CAPACITY: 100GiB
          NVME_PATH: /tmp/ai-toolkit-kvcache
          PATH: /opt/python/bin:/var/lang/bin:/usr/local/bin:/usr/bin/:/bin
          KUBECONFIG: /tmp/.kube/config
          LD_LIBRARY_PATH: /opt/python/lib
          TESTING:
            Fn::If:
              - IsGammaStage
              - 'true'
              - 'false'
      FunctionName:
        Fn::Sub: ${ResourceNamePrefix}-TieredCacheConfig
      Handler: lambda_function.lambda_handler
      Layers:
        - Ref: TieredCacheConfigCustomResourceLayer
      MemorySize: 512
      Role:
        Fn::GetAtt:
          - TieredCacheConfigCustomResourceRole
          - Arn
      Runtime: python3.12
      Timeout: 900
    DependsOn:
      - TieredCacheConfigCustomResourceAccessEntry
    Metadata:
      aws:cdk:path: TieredCacheConfigCfnTemplate/TieredCacheConfigCustomResourceFunction
  TieredCacheConfigCustomResource:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - TieredCacheConfigCustomResourceFunction
          - Arn
      EKSClusterName:
        Ref: EKSClusterName
      HyperPodClusterName:
        Ref: HyperPodClusterName
      TieredStorageConfig:
        Ref: TieredStorageConfig
      TieredKVCacheConfig:
        Ref: TieredKVCacheConfig
    Metadata:
      aws:cdk:path: TieredCacheConfigCfnTemplate/TieredCacheConfigCustomResource
Outputs:
  TieredCacheConfigStatus:
    Description: Status of the tiered cache configuration
    Value:
      Fn::GetAtt:
        - TieredCacheConfigCustomResource
        - KVCacheConfigured
  TieredCacheConfigReason:
    Description: Reason for the tiered cache configuration status
    Value:
      Fn::GetAtt:
        - TieredCacheConfigCustomResource
        - Reason
