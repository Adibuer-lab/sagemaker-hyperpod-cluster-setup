Description: Main Stack for EKS based HyperPod Cluster
Transform: AWS::LanguageExtensions
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: General Settings
        Parameters:
          - ResourceNamePrefix
          - Stage
          - CustomBucketName
          - NodeRecovery
          - NodeProvisioningMode
          - HyperPodClusterRole
          - AutoScalerType
          - Tags
          - EnableHPInferenceFeature
          - EnableObservabilityFeature
          - EnableHPTrainingOperatorFeature
      - Label:
          default: HyperPod Cluster
        Parameters:
          - CreateHyperPodClusterStack
          - HyperPodClusterName
      - Label:
          default: Networking
        Parameters:
          - CreateVPCStack
          - VpcId
          - VpcCIDR
          - AvailabilityZoneIds
          - CreateSecurityGroupStack
          - SecurityGroupId
          - SecurityGroupIds
          - CreatePrivateSubnetStack
          - PrivateSubnetIds
          - EksPrivateSubnetIds
          - NatGatewayIds
          - PrivateRouteTableIds
          - EksPrivateRouteTableIds
          - CreateS3EndpointStack
      - Label:
          default: Orchestration
        Parameters:
          - CreateEKSClusterStack
          - EKSClusterName
          - KubernetesVersion
          - CreateHelmChartStack
          - HelmRepoUrl
          - HelmRepoPath
          - HelmRelease
          - Namespace
          - HelmOperators
      - Label:
          default: Lifecycle Configuration
        Parameters:
          - CreateLifeCycleScriptStack
          - CreateS3BucketStack
          - S3BucketName
          - GithubRawUrl
          - OnCreatePath
      - Label:
          default: Permissions
        Parameters:
          - CreateSageMakerIAMRoleStack
          - SageMakerIAMRoleName
          - HasGatedAccess
      - Label:
          default: HyperPod Data Scientist Setup
        Parameters:
          - DataScientistRole1
          - DataScientistRole1Namespaces
          - DataScientistRole2
          - DataScientistRole2Namespaces
          - DataScientistRole3
          - DataScientistRole3Namespaces
          - DataScientistRole4
          - DataScientistRole4Namespaces
          - DataScientistRole5
          - DataScientistRole5Namespaces
          - DataScientistRole6
          - DataScientistRole6Namespaces
          - DataScientistRole7
          - DataScientistRole7Namespaces
          - DataScientistRole8
          - DataScientistRole8Namespaces
          - DataScientistRole9
          - DataScientistRole9Namespaces
          - DataScientistRole10
          - DataScientistRole10Namespaces
      - Label:
          default: Storage
        Parameters:
          - CreateFsxStack
          - FsxFileSystemId
          - FsxSubnetId
          - FsxAvailabilityZoneId
          - DeploymentType
          - StorageCapacity
          - PerUnitStorageThroughput
          - DataCompressionType
          - FileSystemTypeVersion
      - Label:
          default: Observability
        Parameters:
          - PrometheusWorkspaceId
          - PrometheusWorkspaceArn
          - PrometheusWorkspaceEndpoint
          - GrafanaWorkspaceId
          - GrafanaWorkspaceArn
          - GrafanaWorkspaceName
          - TrainingMetricLevel
          - TaskGovernanceMetricLevel
          - ScalingMetricLevel
          - NetworkMetricLevel
          - ClusterMetricLevel
          - NodeMetricLevel
          - AcceleratedComputeMetricLevel
          - Logging
          - HyperPodObservabilityRole
          - GrafanaRole
          - CreateHyperPodObservabilityRole
          - CreateGrafanaRole
          - CreatePrometheusWorkspace
          - CreateGrafanaWorkspace
      - Label:
          default: Instance Groups
        Parameters:
          - InstanceGroupSettings1
          - InstanceGroupSettings2
          - InstanceGroupSettings3
          - InstanceGroupSettings4
          - InstanceGroupSettings5
          - InstanceGroupSettings6
          - InstanceGroupSettings7
          - InstanceGroupSettings8
          - InstanceGroupSettings9
          - InstanceGroupSettings10
          - InstanceGroupSettings11
          - InstanceGroupSettings12
          - InstanceGroupSettings13
          - InstanceGroupSettings14
          - InstanceGroupSettings15
          - InstanceGroupSettings16
          - InstanceGroupSettings17
          - InstanceGroupSettings18
          - InstanceGroupSettings19
          - InstanceGroupSettings20
      - Label:
          default: Restricted Instance Groups
        Parameters:
          - RigSettings1
          - RigSettings2
          - RigSettings3
          - RigSettings4
          - RigSettings5
          - RigSettings6
          - RigSettings7
          - RigSettings8
          - RigSettings9
          - RigSettings10
          - RigSettings11
          - RigSettings12
          - RigSettings13
          - RigSettings14
          - RigSettings15
          - RigSettings16
          - RigSettings17
          - RigSettings18
          - RigSettings19
          - RigSettings20
    ParameterLabels:
      ResourceNamePrefix:
        default: Resource Name Prefix
      Stage:
        default: Deployment Stage
      EnableHPInferenceFeature:
        default: Feature flag for enabling HP inference
      EnableObservabilityFeature:
        default: Feature flag for enabling observability
      EnableHPTrainingOperatorFeature:
        default: Feature flag for enabling HP training operator
      CustomBucketName:
        default: Custom S3 Bucket Name
      NodeRecovery:
        default: Instance Recovery
      NodeProvisioningMode:
        default: Instance Provisioning Mode
      HyperPodClusterRole:
        default: HyperPod Cluster Role ARN
      AutoScalerType:
        default: Autoscaler
      Tags:
        default: Resource Tags
      CreateVPCStack:
        default: Create New VPC
      VpcId:
        default: Existing VPC ID
      VpcCIDR:
        default: VPC CIDR Range
      AvailabilityZoneIds:
        default: Availability Zone IDs
      CreateSecurityGroupStack:
        default: Create New Security Group
      SecurityGroupId:
        default: Existing Security Group ID
      SecurityGroupIds:
        default: Security Group IDs
      CreatePrivateSubnetStack:
        default: Create Private Subnets
      PrivateSubnetIds:
        default: Private Subnet IDs
      EksPrivateSubnetIds:
        default: EKS Private Subnet IDs
      NatGatewayIds:
        default: NAT Gateway IDs
      PrivateRouteTableIds:
        default: Private Route Table IDs
      EksPrivateRouteTableIds:
        default: EKS Private Route Table IDs
      CreateS3EndpointStack:
        default: Create S3 Endpoint
      CreateEKSClusterStack:
        default: Create New EKS Cluster
      EKSClusterName:
        default: EKS Cluster Name
      KubernetesVersion:
        default: Kubernetes Version
      CreateHelmChartStack:
        default: Install Helm Charts
      HelmRepoUrl:
        default: Helm Repository URL
      HelmRepoPath:
        default: Helm Chart Path
      HelmRelease:
        default: Helm Release Name
      Namespace:
        default: Kubernetes Namespace
      HelmOperators:
        default: Enabled Operators
      CreateLifeCycleScriptStack:
        default: Create Lifecycle Scripts
      CreateS3BucketStack:
        default: Create New S3 Bucket
      S3BucketName:
        default: S3 Bucket Name
      GithubRawUrl:
        default: GitHub Raw URL
      OnCreatePath:
        default: OnCreate Script Path
      CreateSageMakerIAMRoleStack:
        default: Create New IAM Role
      SageMakerIAMRoleName:
        default: IAM Role Name
      HasGatedAccess:
        default: Enable if RIG has gated access
      DataScientistRole1:
        default: Data Scientist Role 1
      DataScientistRole1Namespaces:
        default: Data Scientist Role 1 Namespaces
      DataScientistRole2:
        default: Data Scientist Role 2
      DataScientistRole2Namespaces:
        default: Data Scientist Role 2 Namespaces
      DataScientistRole3:
        default: Data Scientist Role 3
      DataScientistRole3Namespaces:
        default: Data Scientist Role 3 Namespaces
      DataScientistRole4:
        default: Data Scientist Role 4
      DataScientistRole4Namespaces:
        default: Data Scientist Role 4 Namespaces
      DataScientistRole5:
        default: Data Scientist Role 5
      DataScientistRole5Namespaces:
        default: Data Scientist Role 5 Namespaces
      DataScientistRole6:
        default: Data Scientist Role 6
      DataScientistRole6Namespaces:
        default: Data Scientist Role 6 Namespaces
      DataScientistRole7:
        default: Data Scientist Role 7
      DataScientistRole7Namespaces:
        default: Data Scientist Role 7 Namespaces
      DataScientistRole8:
        default: Data Scientist Role 8
      DataScientistRole8Namespaces:
        default: Data Scientist Role 8 Namespaces
      DataScientistRole9:
        default: Data Scientist Role 9
      DataScientistRole9Namespaces:
        default: Data Scientist Role 9 Namespaces
      DataScientistRole10:
        default: Data Scientist Role 10
      DataScientistRole10Namespaces:
        default: Data Scientist Role 10 Namespaces
      CreateFsxStack:
        default: Create New FSx for Lustre File System
      FsxFileSystemId:
        default: Existing FSx File System ID
      FsxSubnetId:
        default: FSx Subnet ID
      FsxAvailabilityZoneId:
        default: FSx Availability Zone
      DeploymentType:
        default: Deployment type
      StorageCapacity:
        default: Storage Capacity (GB)
      PerUnitStorageThroughput:
        default: Per-unit Storage Throughput (MB/s/TiB)
      DataCompressionType:
        default: Compression Type
      FileSystemTypeVersion:
        default: Lustre Version
      CreateHyperPodClusterStack:
        default: Create HyperPod Cluster
      HyperPodClusterName:
        default: HyperPod Cluster Name
      PrometheusWorkspaceId:
        default: Prometheus Workspace Id
      PrometheusWorkspaceArn:
        default: Prometheus Workspace Arn
      PrometheusWorkspaceEndpoint:
        default: Prometheus Workspace Endpoint
      GrafanaWorkspaceId:
        default: Grafana Workspace Id
      GrafanaWorkspaceArn:
        default: Grafana Workspace Arn
      GrafanaWorkspaceName:
        default: Grafana Workspace Name
      TrainingMetricLevel:
        default: Training Metric Level
      TaskGovernanceMetricLevel:
        default: Task Governance  Metric Level
      ClusterMetricLevel:
        default: Cluster Metric Level
      NodeMetricLevel:
        default: Node Metric Level
      AcceleratedComputeMetricLevel:
        default: Accelerated Compute Metric Level
      ScalingMetricLevel:
        default: Scaling Metric Level
      NetworkMetricLevel:
        default: Network Metric Level
      Logging:
        default: Logging
      HyperPodObservabilityRole:
        default: HyperPod Observability Role
      GrafanaRole:
        default: Grafana Role
      CreateHyperPodObservabilityRole:
        default: Create HyperPod Observability Role
      CreateGrafanaRole:
        default: Create Grafana Role
      CreatePrometheusWorkspace:
        default: Create Prometheus Workspace
      CreateGrafanaWorkspace:
        default: Create Grafana Workspace
Parameters:
  Stage:
    Type: String
    Default: prod
    AllowedValues:
      - gamma
      - prod
    Description: Deployment stage (gamma, prod)
  EnableHPInferenceFeature:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Set to "true" to enable the HP inference feature, "false" otherwise.
  EnableObservabilityFeature:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Set to "true" to enable the HP observability feature, "false" otherwise.
  EnableHPTrainingOperatorFeature:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Set to "true" to enable the HP training operator, "false" otherwise.
  HasGatedAccess:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Set to "true" to if RIG has gated access, "false" otherwise.
  CustomBucketName:
    Type: String
    Default: ''
    Description: Custom S3 bucket name for templates. If provided, will override the default bucket. Leave empty to use default.
  ResourceNamePrefix:
    Type: String
    Default: sagemaker-hyperpod-eks
    Description: Prefix to be used for all resources created by this template.
  VpcCIDR:
    Type: String
    Default: 10.192.0.0/16
    Description: The IP range (CIDR notation) for the VPC.
  AvailabilityZoneIds:
    Type: String
    Default: use2-az1,use2-az2
    Description: List of AZs to deploy subnets in (up to 5, comma separated)
  VpcId:
    Type: String
    Default: vpc-1234567890abcdef0
    Description: The ID of the VPC you wish to use if you do not want to create a new VPC.
  NatGatewayIds:
    Type: String
    Default: nat-1234567890abcdef0
    Description: Comma-separated list of NAT Gateway IDs to route internet bound traffic to from the newly created private subnets.
  SecurityGroupId:
    Type: String
    Default: ''
    Description: The ID of the security group associated with an existing EKS cluster.
  KubernetesVersion:
    Type: String
    Default: '1.32'
    Description: The Kubernetes version to use for the EKS cluster.
  EKSClusterName:
    Type: String
    Default: eks
    Description: The name of the newly created of preexisting EKS cluster you wish to use.
  EksPrivateSubnetIds:
    Type: String
    Default: subnet-1234567890abcdef0,subnet-1234567890abcdef0
    Description: Comma-delimited list of private subnet IDs for the EKS cluster
  SecurityGroupIds:
    Type: String
    Default: sg-1234567890abcdef0
    Description: The Id of your cluster security group.
  PrivateRouteTableIds:
    Type: String
    Default: rtb-1234567890abcdef0
    Description: Comma-separated list of private route table IDs.
  EksPrivateRouteTableIds:
    Type: String
    Default: rtb-1234567890abcdef0
    Description: Comma-separated list of EKS private route table IDs.
  S3BucketName:
    Type: String
    Default: s3-bucket
    Description: The name of the S3 bucket used to store the cluster lifecycle scripts.
  GithubRawUrl:
    Type: String
    Default: >-
      https://raw.githubusercontent.com/aws-samples/awsome-distributed-training/refs/heads/main/1.architectures/7.sagemaker-hyperpod-eks/LifecycleScripts/base-config/on_create.sh
    Description: The raw GitHub URL for the lifecycle script.
  HelmRepoUrl:
    Type: String
    Default: https://github.com/aws/sagemaker-hyperpod-cli.git
    Description: The URL of the Helm repo containing the HyperPod Helm chart.
  HelmRepoPath:
    Type: String
    Default: helm_chart/HyperPodHelmChart
    Description: The path to the HyperPod Helm chart in the Helm repo.
  HelmOperators:
    Type: String
    Default: >-
      mlflow.enabled=true,trainingOperators.enabled=true,cluster-role-and-bindings.enabled=true,namespaced-role-and-bindings.enable=true,nvidia-device-plugin.devicePlugin.enabled=true,neuron-device-plugin.devicePlugin.enabled=true,aws-efa-k8s-device-plugin.devicePlugin.enabled=true,mpi-operator.enabled=true,health-monitoring-agent.enabled=true,deep-health-check.enabled=true,job-auto-restart.enabled=true,hyperpod-patching.enabled=true
    Description: The configuration of HyperPod Helm chart
  Namespace:
    Type: String
    Default: kube-system
    Description: The namespace to deploy the HyperPod Helm chart into.
  HelmRelease:
    Type: String
    Default: dependencies
    Description: The name of the Helm release.
  HyperPodClusterName:
    Type: String
    Default: hp-cluster
    Description: Name of SageMaker HyperPod Cluster.
  NodeRecovery:
    Type: String
    Default: Automatic
    AllowedValues:
      - Automatic
      - None
    Description: Specifies whether to enable or disable the automatic node recovery feature (Automatic or None).
  NodeProvisioningMode:
    Type: String
    Default: ''
    AllowedValues:
      - Continuous
      - ''
    Description: Enable or disable the continuous provisioning mode
  SageMakerIAMRoleName:
    Type: String
    Default: iam-role
    Description: The name of the IAM role that SageMaker will use to access the AWS resources on your behalf.
  PrivateSubnetIds:
    Type: String
    Default: subnet-1234567890abcdef0,subnet-1234567890abcdef0
    Description: Comma-separated list of private subnet IDs for EKS cluster.
  OnCreatePath:
    Type: String
    Default: on_create.sh
    Description: >-
      The file name of lifecycle script for the general purpose instance group. This script runs during cluster
      creation.
  HyperPodClusterRole:
    Type: String
    Default: ''
    Description: Hyperpod Cluster Role Arn
  AutoScalerType:
    Type: String
    Default: None
    AllowedValues:
      - Karpenter
      - None
    Description: The type of autoscaler to use
  InstanceGroupSettings1:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings1:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings2:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings2:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings3:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings3:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings4:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings4:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings5:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings5:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings6:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings6:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings7:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings7:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings8:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings8:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings9:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings9:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings10:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings10:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings11:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings11:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings12:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings12:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings13:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings13:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings14:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings14:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings15:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings15:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings16:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings16:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings17:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings17:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings18:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings18:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings19:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings19:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  InstanceGroupSettings20:
    Type: String
    Default: '[]'
    Description: JSON array string containing instance group configurations.
  RigSettings20:
    Type: String
    Default: '[]'
    Description: JSON array string containing restricted instance group configurations.
  RigS3BucketName:
    Type: String
    Default: ''
    Description: The name of the S3 bucket used to store the RIG input resources.
  RigS3OutputBucketName:
    Type: String
    Default: ''
    Description: The name of the S3 bucket used to store the RIG output resources.
  Tags:
    Type: String
    Default: ''
    Description: Custom tags for managing the SageMaker HyperPod cluster as an AWS resource.
  DataScientistRole1:
    Type: String
    Default: ''
    Description: >-
      First HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole1Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole1. Model deployment permissions will be scoped
      to these namespaces. (optional)
  DataScientistRole2:
    Type: String
    Default: ''
    Description: >-
      Second HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole2Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole2. Model deployment permissions will be scoped
      to these namespaces. (optional)
  DataScientistRole3:
    Type: String
    Default: ''
    Description: >-
      Third HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole3Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole3. Model deployment permissions will be scoped
      to these namespaces. (optional)
  DataScientistRole4:
    Type: String
    Default: ''
    Description: >-
      Fourth HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole4Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole4. Model deployment permissions will be scoped
      to these namespaces. (optional)
  DataScientistRole5:
    Type: String
    Default: ''
    Description: >-
      Fifth HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole5Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole5. Model deployment permissions will be scoped
      to these namespaces. (optional)
  DataScientistRole6:
    Type: String
    Default: ''
    Description: >-
      Sixth HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole6Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole6. Model deployment permissions will be scoped
      to these namespaces. (optional)
  DataScientistRole7:
    Type: String
    Default: ''
    Description: >-
      Seventh HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole7Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole7. Model deployment permissions will be scoped
      to these namespaces. (optional)
  DataScientistRole8:
    Type: String
    Default: ''
    Description: >-
      Eighth HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole8Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole8. Model deployment permissions will be scoped
      to these namespaces. (optional)
  DataScientistRole9:
    Type: String
    Default: ''
    Description: >-
      Ninth HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole9Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole9. Model deployment permissions will be scoped
      to these namespaces. (optional)
  DataScientistRole10:
    Type: String
    Default: ''
    Description: >-
      Tenth HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole10Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole10. Model deployment permissions will be scoped
      to these namespaces. (optional)
  FsxSubnetId:
    Type: String
    Default: ''
    Description: The subnet id that will be used to create FSx
  FsxAvailabilityZoneId:
    Type: String
    Default: use2-az1
    Description: The availability zone to get subnet id that will be used to create FSx
  PerUnitStorageThroughput:
    Type: Number
    Default: 250
    Description: Per unit storage throughput for the FSx file system
  DataCompressionType:
    Type: String
    Default: NONE
    AllowedValues:
      - NONE
      - LZ4
    Description: Data compression type for the FSx file system (NONE, LZ4)
  FileSystemTypeVersion:
    Type: Number
    Default: 2.15
    Description: File system type version for the FSx file system
  StorageCapacity:
    Type: Number
    Default: 1200
    Description: Storage capacity for the FSx file system in GiB
  DeploymentType:
    Type: String
    Default: PERSISTENT_2
    Description: Deployment type for the FSx file system
  FsxFileSystemId:
    Type: String
    Default: ''
    Description: Existing FSx for Lustre file system
  PrometheusWorkspaceId:
    Type: String
    Default: ''
    Description: The ID of the existing Amazon Managed Service for Prometheus (AMP) workspace.
  PrometheusWorkspaceArn:
    Type: String
    Default: ''
    Description: The ARN of the existing Amazon Managed Service for Prometheus (AMP) workspace.
  PrometheusWorkspaceEndpoint:
    Type: String
    Default: ''
    Description: The Endpoint of the existing Amazon Managed Service for Prometheus (AMP) workspace.
  GrafanaWorkspaceId:
    Type: String
    Default: ''
    Description: The ID of the existing Amazon Managed Service for Grafana (AMG) workspace.
  GrafanaWorkspaceArn:
    Type: String
    Default: ''
    Description: The Arn of the existing Amazon Managed Service for Grafana (AMG) workspace.
  TrainingMetricLevel:
    Type: String
    Default: BASIC
    Description: The level of training metric for EKS AddOn.
  TaskGovernanceMetricLevel:
    Type: String
    Default: DISABLED
    Description: The level of task governance metric for EKS AddOn.
  ClusterMetricLevel:
    Type: String
    Default: BASIC
    Description: The level of cluster metric for EKS AddOn.
  NodeMetricLevel:
    Type: String
    Default: BASIC
    Description: The level of node metric for EKS AddOn.
  AcceleratedComputeMetricLevel:
    Type: String
    Default: BASIC
    Description: The level of accelerated compute metric for EKS AddOn.
  ScalingMetricLevel:
    Type: String
    Default: DISABLED
    Description: The level of scaling metric for EKS AddOn.
  NetworkMetricLevel:
    Type: String
    Default: DISABLED
    Description: The level of network metric for EKS AddOn.
  GrafanaWorkspaceName:
    Type: String
    Default: ''
    Description: The name to be used for grafana by this template.
  Logging:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Specify whether to enable logging
  HyperPodObservabilityRole:
    Type: String
    Default: ''
    Description: The role to be used with Hyperpod Observability AddOn
  GrafanaRole:
    Type: String
    Default: ''
    Description: The role to be used with Hyperpod Observability Grafana Custom Resources
  CreateHyperPodObservabilityRole:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Specify whether to create new role for Hyperpod Observability AddOn
  CreateGrafanaRole:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Specify whether to create new role for Hyperpod Observability Grafana Custom Resources
  CreatePrometheusWorkspace:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Specify whether to create new prometheus workspace
  CreateGrafanaWorkspace:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
      - disabled
    Description: Specify whether to create new grafana workspace
  ObservabilityCfnStackFunctionS3Key:
    Type: String
    Default: resources/artifacts/observability-stack-lambda-function.zip
    Description: The S3 key for the lambda function zip file.
  CreateVPCStack:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Boolean to Create VPC Stack
  CreateSecurityGroupStack:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Boolean to Create Security Group Stack
  CreateEKSClusterStack:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Boolean to Create EKS Cluster Stack
  CreateS3BucketStack:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Boolean to Create S3 Bucket Stack
  CreateS3EndpointStack:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Boolean to Create S3 Endpoint Stack
  CreateLifeCycleScriptStack:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Boolean to Create Life Cycle Script Stack
  CreateSageMakerIAMRoleStack:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Boolean to Create SageMaker IAM Role Stack
  CreateHelmChartStack:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Boolean to Create Helm Chart Stack
  CreateHyperPodClusterStack:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Boolean to Create HyperPod Cluster Stack
  CreateFsxStack:
    Type: String
    Default: 'true'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Boolean to Create FSx for Lustre File System Stack
Conditions:
  EnableHPInferenceFeatureCondition:
    Fn::Equals:
      - Ref: EnableHPInferenceFeature
      - 'true'
  EnableObservabilityFeatureCondition:
    Fn::And:
      - Fn::Equals:
          - Ref: EnableObservabilityFeature
          - 'true'
      - Fn::Equals:
          - Fn::FindInMap:
              - AMPRegionMapping
              - Ref: AWS::Region
              - isAllowed
              - DefaultValue: 'false'
          - 'true'
  EnableHPTrainingOperatorFeatureCondition:
    Fn::Equals:
      - Ref: EnableHPTrainingOperatorFeature
      - 'true'
  CreateVPCStackCondition:
    Fn::Equals:
      - Ref: CreateVPCStack
      - 'true'
  CreatePrivateSubnetStackCondition:
    Fn::Equals:
      - Ref: CreateVPCStack
      - 'true'
  CreateSecurityGroupStackCondition:
    Fn::Equals:
      - Ref: CreateSecurityGroupStack
      - 'true'
  CreateEKSClusterStackCondition:
    Fn::Equals:
      - Ref: CreateEKSClusterStack
      - 'true'
  CreateS3BucketStackCondition:
    Fn::Equals:
      - Ref: CreateS3BucketStack
      - 'true'
  CreateS3EndpointStackCondition:
    Fn::Equals:
      - Ref: CreateS3EndpointStack
      - 'true'
  CreateLifeCycleScriptStackCondition:
    Fn::Equals:
      - Ref: CreateLifeCycleScriptStack
      - 'true'
  CreateSageMakerIAMRoleStackCondition:
    Fn::Equals:
      - Ref: CreateSageMakerIAMRoleStack
      - 'true'
  CreateHelmChartStackCondition:
    Fn::Equals:
      - Ref: CreateHelmChartStack
      - 'true'
  CreateHyperPodClusterStackCondition:
    Fn::And:
      - Fn::Equals:
          - Ref: CreateHyperPodClusterStack
          - 'true'
      - Fn::Not:
          - Fn::And:
              - Fn::Equals:
                  - Ref: CreateEKSClusterStack
                  - 'true'
              - Fn::Equals:
                  - Ref: CreateHelmChartStack
                  - 'false'
  CreateFsxStackCondition:
    Fn::Equals:
      - Ref: CreateFsxStack
      - 'true'
  CreateRigCondition:
    Fn::Not:
      - Fn::Equals:
          - Ref: RigSettings1
          - '[]'
  InstallCertManagerCondition:
    Fn::Or:
      - Condition: EnableHPInferenceFeatureCondition
      - Condition: EnableHPTrainingOperatorFeatureCondition
  DataScientistSetupCondition:
    Fn::Or:
      - Fn::Not:
          - Fn::Equals:
              - Ref: DataScientistRole1
              - ''
      - Fn::Not:
          - Fn::Equals:
              - Ref: DataScientistRole2
              - ''
      - Fn::Not:
          - Fn::Equals:
              - Ref: DataScientistRole3
              - ''
      - Fn::Not:
          - Fn::Equals:
              - Ref: DataScientistRole4
              - ''
      - Fn::Not:
          - Fn::Equals:
              - Ref: DataScientistRole5
              - ''
      - Fn::Not:
          - Fn::Equals:
              - Ref: DataScientistRole6
              - ''
      - Fn::Not:
          - Fn::Equals:
              - Ref: DataScientistRole7
              - ''
      - Fn::Not:
          - Fn::Equals:
              - Ref: DataScientistRole8
              - ''
      - Fn::Not:
          - Fn::Equals:
              - Ref: DataScientistRole9
              - ''
      - Fn::Not:
          - Fn::Equals:
              - Ref: DataScientistRole10
              - ''
  CustomBucketCondition:
    Fn::Not:
      - Fn::Equals:
          - Ref: CustomBucketName
          - ''
Mappings:
  AMPRegionMapping:
    us-east-1:
      isAllowed: 'true'
    us-east-2:
      isAllowed: 'true'
    us-west-2:
      isAllowed: 'true'
    ap-south-1:
      isAllowed: 'true'
    ap-northeast-1:
      isAllowed: 'true'
    ap-northeast-2:
      isAllowed: 'true'
    ap-southeast-1:
      isAllowed: 'true'
    ap-southeast-2:
      isAllowed: 'true'
    ca-central-1:
      isAllowed: 'true'
    eu-central-1:
      isAllowed: 'true'
    eu-west-1:
      isAllowed: 'true'
    eu-west-2:
      isAllowed: 'true'
    eu-north-1:
      isAllowed: 'true'
    sa-east-1:
      isAllowed: 'true'
Resources:
  VPCStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::If:
          - CustomBucketCondition
          - Fn::Sub: https://${CustomBucketName}.s3.${AWS::Region}.amazonaws.com/templates/vpc-template.yaml
          - Fn::Sub: >-
              https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/vpc-template.yaml
      Parameters:
        ResourceNamePrefix:
          Ref: ResourceNamePrefix
        VpcCIDR:
          Ref: VpcCIDR
        AvailabilityZoneIds:
          Fn::Join:
            - ','
            - - Ref: AvailabilityZoneIds
              - ',,,'
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/VPCStack
    Condition: CreateVPCStackCondition
  PrivateSubnetStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::If:
          - CustomBucketCondition
          - Fn::Sub: https://${CustomBucketName}.s3.${AWS::Region}.amazonaws.com/templates/private-subnet-template.yaml
          - Fn::Sub: >-
              https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/private-subnet-template.yaml
      Parameters:
        ResourceNamePrefix:
          Ref: ResourceNamePrefix
        VpcId:
          Fn::If:
            - CreateVPCStackCondition
            - Fn::GetAtt:
                - VPCStack
                - Outputs.VpcId
            - Ref: VpcId
        VpcCidrBlock:
          Ref: VpcCIDR
        AvailabilityZoneIds:
          Fn::Join:
            - ','
            - - Ref: AvailabilityZoneIds
              - ',,,'
        NatGatewayIds:
          Fn::If:
            - CreateVPCStackCondition
            - Fn::GetAtt:
                - VPCStack
                - Outputs.NatGatewayIds
            - Ref: NatGatewayIds
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/PrivateSubnetStack
    Condition: CreatePrivateSubnetStackCondition
  SecurityGroupStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::If:
          - CustomBucketCondition
          - Fn::Sub: https://${CustomBucketName}.s3.${AWS::Region}.amazonaws.com/templates/security-group-template.yaml
          - Fn::Sub: >-
              https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/security-group-template.yaml
      Parameters:
        ResourceNamePrefix:
          Ref: ResourceNamePrefix
        VpcId:
          Fn::If:
            - CreateVPCStackCondition
            - Fn::GetAtt:
                - VPCStack
                - Outputs.VpcId
            - Ref: VpcId
        SecurityGroupId:
          Ref: SecurityGroupId
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/SecurityGroupStack
    Condition: CreateSecurityGroupStackCondition
  EKSClusterStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::If:
          - CustomBucketCondition
          - Fn::Sub: https://${CustomBucketName}.s3.${AWS::Region}.amazonaws.com/templates/eks-template.yaml
          - Fn::Sub: >-
              https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/eks-template.yaml
      Parameters:
        ResourceNamePrefix:
          Ref: ResourceNamePrefix
        VpcId:
          Fn::If:
            - CreateVPCStackCondition
            - Fn::GetAtt:
                - VPCStack
                - Outputs.VpcId
            - Ref: VpcId
        KubernetesVersion:
          Ref: KubernetesVersion
        EKSClusterName:
          Ref: EKSClusterName
        EksPrivateSubnetIds:
          Fn::If:
            - CreatePrivateSubnetStackCondition
            - Fn::GetAtt:
                - PrivateSubnetStack
                - Outputs.EksPrivateSubnetIds
            - Ref: EksPrivateSubnetIds
        SecurityGroupIds:
          Fn::If:
            - CreateSecurityGroupStackCondition
            - Fn::GetAtt:
                - SecurityGroupStack
                - Outputs.SecurityGroupId
            - Ref: SecurityGroupIds
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/EKSClusterStack
    Condition: CreateEKSClusterStackCondition
  S3BucketStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::If:
          - CustomBucketCondition
          - Fn::Sub: https://${CustomBucketName}.s3.${AWS::Region}.amazonaws.com/templates/s3-bucket-template.yaml
          - Fn::Sub: >-
              https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/s3-bucket-template.yaml
      Parameters:
        ResourceNamePrefix:
          Ref: ResourceNamePrefix
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/S3BucketStack
    Condition: CreateS3BucketStackCondition
  S3EndpointStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::If:
          - CustomBucketCondition
          - Fn::Sub: https://${CustomBucketName}.s3.${AWS::Region}.amazonaws.com/templates/s3-endpoint-template.yaml
          - Fn::Sub: >-
              https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/s3-endpoint-template.yaml
      Parameters:
        VpcId:
          Fn::If:
            - CreateVPCStackCondition
            - Fn::GetAtt:
                - VPCStack
                - Outputs.VpcId
            - Ref: VpcId
        PrivateRouteTableIds:
          Fn::If:
            - CreatePrivateSubnetStackCondition
            - Fn::GetAtt:
                - PrivateSubnetStack
                - Outputs.PrivateRouteTableIds
            - Ref: PrivateRouteTableIds
        EksPrivateRouteTableIds:
          Fn::If:
            - CreatePrivateSubnetStackCondition
            - Fn::GetAtt:
                - PrivateSubnetStack
                - Outputs.EksPrivateRouteTableIds
            - Ref: EksPrivateRouteTableIds
        ResourceNamePrefix:
          Ref: ResourceNamePrefix
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/S3EndpointStack
    Condition: CreateS3EndpointStackCondition
  LifeCycleScriptStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::If:
          - CustomBucketCondition
          - Fn::Sub: https://${CustomBucketName}.s3.${AWS::Region}.amazonaws.com/templates/lifecycle-script-template.yaml
          - Fn::Sub: >-
              https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/lifecycle-script-template.yaml
      Parameters:
        ResourceNamePrefix:
          Ref: ResourceNamePrefix
        S3BucketName:
          Fn::If:
            - CreateS3BucketStackCondition
            - Fn::GetAtt:
                - S3BucketStack
                - Outputs.S3BucketName
            - Ref: S3BucketName
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/LifeCycleScriptStack
    Condition: CreateLifeCycleScriptStackCondition
  SageMakerIAMRoleStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::If:
          - CustomBucketCondition
          - Fn::Sub: https://${CustomBucketName}.s3.${AWS::Region}.amazonaws.com/templates/sagemaker-iam-role-template.yaml
          - Fn::Sub: >-
              https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/sagemaker-iam-role-template.yaml
      Parameters:
        ResourceNamePrefix:
          Ref: ResourceNamePrefix
        S3BucketName:
          Fn::If:
            - CreateS3BucketStackCondition
            - Fn::GetAtt:
                - S3BucketStack
                - Outputs.S3BucketName
            - Ref: S3BucketName
        RigS3BucketName:
          Ref: RigS3BucketName
        RigS3OutputBucketName:
          Ref: RigS3OutputBucketName
        EKSClusterName:
          Fn::If:
            - CreateEKSClusterStackCondition
            - Fn::GetAtt:
                - EKSClusterStack
                - Outputs.EKSClusterName
            - Ref: EKSClusterName
        VpcId:
          Fn::If:
            - CreateVPCStackCondition
            - Fn::GetAtt:
                - VPCStack
                - Outputs.VpcId
            - Ref: VpcId
        SecurityGroupIds:
          Fn::If:
            - CreateSecurityGroupStackCondition
            - Fn::GetAtt:
                - SecurityGroupStack
                - Outputs.SecurityGroupId
            - Ref: SecurityGroupIds
        PrivateSubnetIds:
          Fn::If:
            - CreatePrivateSubnetStackCondition
            - Fn::GetAtt:
                - PrivateSubnetStack
                - Outputs.PrivateSubnetIds
            - Ref: PrivateSubnetIds
        CreateRIG:
          Fn::If:
            - CreateRigCondition
            - 'true'
            - 'false'
        HasGatedAccess:
          Ref: HasGatedAccess
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/SageMakerIAMRoleStack
    Condition: CreateSageMakerIAMRoleStackCondition
  HelmChartStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::If:
          - CustomBucketCondition
          - Fn::Sub: https://${CustomBucketName}.s3.${AWS::Region}.amazonaws.com/templates/helm-chart-template.yaml
          - Fn::Sub: >-
              https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/helm-chart-template.yaml
      Parameters:
        ResourceNamePrefix:
          Ref: ResourceNamePrefix
        HelmRepoUrl:
          Ref: HelmRepoUrl
        HelmRepoPath:
          Ref: HelmRepoPath
        Namespace:
          Ref: Namespace
        HelmRelease:
          Ref: HelmRelease
        HelmOperators:
          Ref: HelmOperators
        CreateRIG:
          Fn::If:
            - CreateRigCondition
            - 'true'
            - 'false'
        CustomResourceS3Bucket:
          Fn::If:
            - CustomBucketCondition
            - Ref: CustomBucketName
            - Fn::Sub: aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}
        EKSClusterName:
          Fn::If:
            - CreateEKSClusterStackCondition
            - Fn::GetAtt:
                - EKSClusterStack
                - Outputs.EKSClusterName
            - Ref: EKSClusterName
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/HelmChartStack
    Condition: CreateHelmChartStackCondition
  HyperPodParamClusterStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::If:
          - CustomBucketCondition
          - Fn::Sub: https://${CustomBucketName}.s3.${AWS::Region}.amazonaws.com/templates/hyperpod-cluster-template.yaml
          - Fn::Sub: >-
              https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/hyperpod-cluster-template.yaml
      Parameters:
        ResourceNamePrefix:
          Ref: ResourceNamePrefix
        HelmChartStatus:
          Fn::If:
            - CreateHelmChartStackCondition
            - Fn::GetAtt:
                - HelmChartStack
                - Outputs.HelmChartDeploymentComplete
            - HelmChartNotRequired
        FsxStatus:
          Fn::If:
            - CreateFsxStackCondition
            - Fn::GetAtt:
                - FsxStack
                - Outputs.FsxDeploymentComplete
            - FsxNotRequired
        HyperPodClusterName:
          Ref: HyperPodClusterName
        NodeRecovery:
          Ref: NodeRecovery
        NodeProvisioningMode:
          Ref: NodeProvisioningMode
        HyperPodClusterRole:
          Ref: HyperPodClusterRole
        AutoScalerType:
          Ref: AutoScalerType
        EKSClusterName:
          Fn::If:
            - CreateEKSClusterStackCondition
            - Fn::GetAtt:
                - EKSClusterStack
                - Outputs.EKSClusterName
            - Ref: EKSClusterName
        SecurityGroupIds:
          Fn::If:
            - CreateSecurityGroupStackCondition
            - Fn::GetAtt:
                - SecurityGroupStack
                - Outputs.SecurityGroupId
            - Ref: SecurityGroupIds
        PrivateSubnetIds:
          Fn::If:
            - CreatePrivateSubnetStackCondition
            - Fn::GetAtt:
                - PrivateSubnetStack
                - Outputs.PrivateSubnetIds
            - Ref: PrivateSubnetIds
        CustomResourceS3Bucket:
          Fn::If:
            - CustomBucketCondition
            - Ref: CustomBucketName
            - Fn::Sub: aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}
        SageMakerIAMRoleName:
          Fn::If:
            - CreateSageMakerIAMRoleStackCondition
            - Fn::GetAtt:
                - SageMakerIAMRoleStack
                - Outputs.SageMakerIAMRoleName
            - Ref: SageMakerIAMRoleName
        S3BucketName:
          Fn::If:
            - CreateS3BucketStackCondition
            - Fn::GetAtt:
                - S3BucketStack
                - Outputs.S3BucketName
            - Ref: S3BucketName
        OnCreatePath:
          Fn::If:
            - CreateS3BucketStackCondition
            - on_create.sh
            - Ref: OnCreatePath
        EnableHPTrainingOperatorFeature:
          Ref: EnableHPTrainingOperatorFeature
        InstanceGroupSettings1:
          Ref: InstanceGroupSettings1
        InstanceGroupSettings2:
          Ref: InstanceGroupSettings2
        InstanceGroupSettings3:
          Ref: InstanceGroupSettings3
        InstanceGroupSettings4:
          Ref: InstanceGroupSettings4
        InstanceGroupSettings5:
          Ref: InstanceGroupSettings5
        InstanceGroupSettings6:
          Ref: InstanceGroupSettings6
        InstanceGroupSettings7:
          Ref: InstanceGroupSettings7
        InstanceGroupSettings8:
          Ref: InstanceGroupSettings8
        InstanceGroupSettings9:
          Ref: InstanceGroupSettings9
        InstanceGroupSettings10:
          Ref: InstanceGroupSettings10
        InstanceGroupSettings11:
          Ref: InstanceGroupSettings11
        InstanceGroupSettings12:
          Ref: InstanceGroupSettings12
        InstanceGroupSettings13:
          Ref: InstanceGroupSettings13
        InstanceGroupSettings14:
          Ref: InstanceGroupSettings14
        InstanceGroupSettings15:
          Ref: InstanceGroupSettings15
        InstanceGroupSettings16:
          Ref: InstanceGroupSettings16
        InstanceGroupSettings17:
          Ref: InstanceGroupSettings17
        InstanceGroupSettings18:
          Ref: InstanceGroupSettings18
        InstanceGroupSettings19:
          Ref: InstanceGroupSettings19
        InstanceGroupSettings20:
          Ref: InstanceGroupSettings20
        RigSettings1:
          Ref: RigSettings1
        RigSettings2:
          Ref: RigSettings2
        RigSettings3:
          Ref: RigSettings3
        RigSettings4:
          Ref: RigSettings4
        RigSettings5:
          Ref: RigSettings5
        RigSettings6:
          Ref: RigSettings6
        RigSettings7:
          Ref: RigSettings7
        RigSettings8:
          Ref: RigSettings8
        RigSettings9:
          Ref: RigSettings9
        RigSettings10:
          Ref: RigSettings10
        RigSettings11:
          Ref: RigSettings11
        RigSettings12:
          Ref: RigSettings12
        RigSettings13:
          Ref: RigSettings13
        RigSettings14:
          Ref: RigSettings14
        RigSettings15:
          Ref: RigSettings15
        RigSettings16:
          Ref: RigSettings16
        RigSettings17:
          Ref: RigSettings17
        RigSettings18:
          Ref: RigSettings18
        RigSettings19:
          Ref: RigSettings19
        RigSettings20:
          Ref: RigSettings20
        Tags:
          Ref: Tags
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/HyperPodParamClusterStack
    Condition: CreateHyperPodClusterStackCondition
  HyperPodClusterStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::GetAtt:
          - HyperPodParamClusterStack
          - Outputs.HyperPodClusterTemplateUrlOutput
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/HyperPodClusterStack
    Condition: CreateHyperPodClusterStackCondition
  CertManagerStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::If:
          - CustomBucketCondition
          - Fn::Sub: https://${CustomBucketName}.s3.${AWS::Region}.amazonaws.com/templates/cert-manager-template.yaml
          - Fn::Sub: >-
              https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/cert-manager-template.yaml
      Parameters:
        ResourceNamePrefix:
          Ref: ResourceNamePrefix
        EKSClusterName:
          Fn::If:
            - CreateEKSClusterStackCondition
            - Fn::GetAtt:
                - EKSClusterStack
                - Outputs.EKSClusterName
            - Ref: EKSClusterName
    DependsOn:
      - EKSClusterStack
      - HyperPodClusterStack
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/CertManagerStack
    Condition: InstallCertManagerCondition
  FsxStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::If:
          - CustomBucketCondition
          - Fn::Sub: https://${CustomBucketName}.s3.${AWS::Region}.amazonaws.com/templates/fsx-template.yaml
          - Fn::Sub: >-
              https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/fsx-template.yaml
      Parameters:
        ResourceNamePrefix:
          Ref: ResourceNamePrefix
        HelmChartStatus:
          Fn::If:
            - CreateHelmChartStackCondition
            - Fn::GetAtt:
                - HelmChartStack
                - Outputs.HelmChartDeploymentComplete
            - HelmChartNotRequired
        EKSClusterName:
          Fn::If:
            - CreateEKSClusterStackCondition
            - Fn::GetAtt:
                - EKSClusterStack
                - Outputs.EKSClusterName
            - Ref: EKSClusterName
        CustomResourceS3Bucket:
          Fn::If:
            - CustomBucketCondition
            - Ref: CustomBucketName
            - Fn::Sub: aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}
        PrivateSubnetIds:
          Fn::If:
            - CreatePrivateSubnetStackCondition
            - Fn::GetAtt:
                - PrivateSubnetStack
                - Outputs.PrivateSubnetIds
            - Ref: PrivateSubnetIds
        FsxSubnetId:
          Ref: FsxSubnetId
        FsxAvailabilityZoneId:
          Ref: FsxAvailabilityZoneId
        DeploymentType:
          Ref: DeploymentType
        SecurityGroupIds:
          Fn::If:
            - CreateSecurityGroupStackCondition
            - Fn::GetAtt:
                - SecurityGroupStack
                - Outputs.SecurityGroupId
            - Ref: SecurityGroupIds
        PerUnitStorageThroughput:
          Ref: PerUnitStorageThroughput
        DataCompressionType:
          Ref: DataCompressionType
        FileSystemTypeVersion:
          Ref: FileSystemTypeVersion
        StorageCapacity:
          Ref: StorageCapacity
        FsxFileSystemId:
          Ref: FsxFileSystemId
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/FsxStack
    Condition: CreateFsxStackCondition
  PrivateSubnetTagsStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::If:
          - CustomBucketCondition
          - Fn::Sub: https://${CustomBucketName}.s3.${AWS::Region}.amazonaws.com/templates/private-subnet-tagging-template.yaml
          - Fn::Sub: >-
              https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/private-subnet-tagging-template.yaml
      Parameters:
        CustomResourceS3Bucket:
          Fn::If:
            - CustomBucketCondition
            - Ref: CustomBucketName
            - Fn::Sub: aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}
        PrivateSubnetIds:
          Fn::If:
            - CreatePrivateSubnetStackCondition
            - Fn::GetAtt:
                - PrivateSubnetStack
                - Outputs.PrivateSubnetIds
            - Ref: PrivateSubnetIds
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/PrivateSubnetTagsStack
    Condition: EnableHPInferenceFeatureCondition
  InferenceOperatorMainStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::If:
          - CustomBucketCondition
          - Fn::Sub: >-
              https://${CustomBucketName}.s3.${AWS::Region}.amazonaws.com/templates/inference-operator-main-stack-template.yaml
          - Fn::Sub: >-
              https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/inference-operator-main-stack-template.yaml
      Parameters:
        ResourceNamePrefix:
          Ref: ResourceNamePrefix
        Stage:
          Ref: Stage
        CustomBucketName:
          Ref: CustomBucketName
        EKSClusterName:
          Fn::If:
            - CreateEKSClusterStackCondition
            - Fn::GetAtt:
                - EKSClusterStack
                - Outputs.EKSClusterName
            - Ref: EKSClusterName
        OIDCProviderURL:
          Fn::If:
            - CreateEKSClusterStackCondition
            - Fn::GetAtt:
                - EKSClusterStack
                - Outputs.OIDCProviderURL
            - ''
        OIDCProviderURLWithoutProtocol:
          Fn::If:
            - CreateEKSClusterStackCondition
            - Fn::GetAtt:
                - EKSClusterStack
                - Outputs.OIDCProviderURLWithoutProtocol
            - ''
        HelmRepoUrl:
          Ref: HelmRepoUrl
        HelmRepoPath:
          Ref: HelmRepoPath
        Namespace:
          Ref: Namespace
        HPClusterArn:
          Fn::GetAtt:
            - HyperPodClusterStack
            - Outputs.HyperPodClusterArn
        VpcId:
          Fn::If:
            - CreateVPCStackCondition
            - Fn::GetAtt:
                - VPCStack
                - Outputs.VpcId
            - Ref: VpcId
        AccessLogsBucketName:
          Fn::If:
            - CreateS3BucketStackCondition
            - Fn::GetAtt:
                - S3BucketStack
                - Outputs.S3LogsBucketName
            - Fn::Sub:
                - ${ResourceNamePrefix}-logs
                - ResourceNamePrefix:
                    Ref: ResourceNamePrefix
    DependsOn:
      - CertManagerStack
      - HyperPodClusterStack
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/InferenceOperatorMainStack
    Condition: EnableHPInferenceFeatureCondition
  ObservabilityCustomResourceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AmazonSageMakerHyperPodObservabilityAdminAccess
        - arn:aws:iam::aws:policy/AWSCloudFormationFullAccess
      Policies:
        - PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - lambda:CreateFunction
                  - lambda:TagResource
                Resource: '*'
                Condition:
                  StringEqualsIfExists:
                    aws:RequestTag/SageMaker: 'true'
              - Effect: Allow
                Action:
                  - lambda:InvokeFunction
                  - lambda:DeleteFunction
                  - lambda:GetFunction
                  - lambda:UpdateFunction
                Resource:
                  Fn::Sub: arn:${AWS::Partition}:lambda:${AWS::Region}:${AWS::AccountId}:function:${ResourceNamePrefix}*
              - Effect: Allow
                Action:
                  - aps:DescribeLoggingConfiguration
                  - aps:DescribeWorkspaceConfiguration
                  - aps:DescribeQueryLoggingConfiguration
                Resource:
                  Fn::Sub: arn:${AWS::Partition}:aps:${AWS::Region}:${AWS::AccountId}:workspace/*
              - Effect: Allow
                Action:
                  - aps:TagResource
                Resource:
                  Fn::Sub: arn:${AWS::Partition}:aps:${AWS::Region}:${AWS::AccountId}:/workspaces
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource: '*'
              - Effect: Allow
                Action:
                  - iam:GetRole
                  - iam:DeleteRolePolicy
                  - iam:PutRolePolicy
                  - iam:DetachRolePolicy
                  - iam:AttachRolePolicy
                  - iam:GetRolePolicy
                  - iam:DeleteRole
                  - iam:CreateRole
                Resource:
                  - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/*
              - Effect: Allow
                Action:
                  - iam:PassRole
                Resource:
                  - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/${ResourceNamePrefix}*
                  - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/service-role/${ResourceNamePrefix}*
              - Effect: Allow
                Action:
                  - ec2:CreateNetworkInterface
                  - ec2:CreateTags
                  - ec2:DeleteNetworkInterface
                  - ec2:CreateVpcEndpoint
                  - ec2:DescribeVpcEndpoint
                Resource:
                  - Fn::Sub: arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:security-group/*
                  - Fn::Sub: arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:subnet/*
                  - Fn::Sub: arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:network-interface/*
                  - Fn::Sub: arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:vpc-endpoint/*
                  - Fn::Sub: arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:route-table/*
                  - Fn::If:
                      - CreateVPCStackCondition
                      - Fn::Sub: arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:vpc/${VPCStack.Outputs.VpcId}
                      - Fn::Sub: arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:vpc/${VpcId}
              - Effect: Allow
                Action:
                  - ec2:DeleteNetworkInterface
                Resource:
                  - Fn::Sub: arn:${AWS::Partition}:ec2:${AWS::Region}:${AWS::AccountId}:*/*
              - Effect: Allow
                Action:
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DescribeVpcs
                  - ec2:DescribeSubnets
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeVpcEndpoints
                Resource: '*'
              - Effect: Allow
                Action:
                  - ec2:DeleteVpcEndpoints
                  - ec2:CreateTags
                Resource:
                  Fn::Sub: arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:vpc-endpoint/*
              - Effect: Allow
                Action:
                  - route53:AssociateVPCWithHostedZone
                Resource:
                  Fn::Sub: arn:aws:route53:::hostedzone/*
          PolicyName:
            Fn::Sub: ${ResourceNamePrefix}-CFNStack4
      RoleName:
        Fn::Sub: ${ResourceNamePrefix}-ObsRole
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/ObservabilityCustomResourceRole
    Condition: EnableObservabilityFeatureCondition
  ObservabilityCustomResourceFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::If:
            - CustomBucketCondition
            - Ref: CustomBucketName
            - Fn::Sub: aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}
        S3Key:
          Ref: ObservabilityCfnStackFunctionS3Key
      Environment:
        Variables:
          REGION:
            Fn::Sub: ${AWS::Region}
          AWS_ACCOUNT_ID:
            Fn::Sub: ${AWS::AccountId}
          PARTITION:
            Fn::Sub: ${AWS::Partition}
      FunctionName:
        Fn::Sub: ${ResourceNamePrefix}-ObsFunc
      Handler: lambda_function.lambda_handler
      MemorySize: 2048
      Role:
        Fn::GetAtt:
          - ObservabilityCustomResourceRole
          - Arn
      Runtime: python3.12
      Tags:
        - Key: SageMaker
          Value: 'true'
      Timeout: 900
    DependsOn:
      - ObservabilityCustomResourceRole
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/ObservabilityCustomResourceFunction
    Condition: EnableObservabilityFeatureCondition
  ObservabilityCustomResource:
    Type: Custom::ObservabilityStack
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - ObservabilityCustomResourceFunction
          - Arn
      ResourceNamePrefix:
        Ref: ResourceNamePrefix
      EKSClusterName:
        Fn::If:
          - CreateEKSClusterStackCondition
          - Fn::GetAtt:
              - EKSClusterStack
              - Outputs.EKSClusterName
          - Ref: EKSClusterName
      CustomResourceS3Bucket:
        Fn::If:
          - CustomBucketCondition
          - Ref: CustomBucketName
          - Fn::Sub: aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}
      PrivateSubnetIds:
        Fn::If:
          - CreatePrivateSubnetStackCondition
          - Fn::GetAtt:
              - PrivateSubnetStack
              - Outputs.PrivateSubnetIds
          - Ref: PrivateSubnetIds
      SecurityGroupId:
        Fn::If:
          - CreateSecurityGroupStackCondition
          - Fn::GetAtt:
              - SecurityGroupStack
              - Outputs.SecurityGroupId
          - Ref: SecurityGroupIds
      VpcId:
        Fn::If:
          - CreateVPCStackCondition
          - Fn::GetAtt:
              - VPCStack
              - Outputs.VpcId
          - Ref: VpcId
      TrainingMetricLevel:
        Ref: TrainingMetricLevel
      TaskGovernanceMetricLevel:
        Ref: TaskGovernanceMetricLevel
      ScalingMetricLevel:
        Ref: ScalingMetricLevel
      NetworkMetricLevel:
        Ref: NetworkMetricLevel
      ClusterMetricLevel:
        Ref: ClusterMetricLevel
      NodeMetricLevel:
        Ref: NodeMetricLevel
      AcceleratedComputeMetricLevel:
        Ref: AcceleratedComputeMetricLevel
      Logging:
        Ref: Logging
      GrafanaWorkspaceName:
        Ref: GrafanaWorkspaceName
      GrafanaWorkspaceId:
        Ref: GrafanaWorkspaceId
      GrafanaWorkspaceArn:
        Ref: GrafanaWorkspaceArn
      PrometheusWorkspaceId:
        Ref: PrometheusWorkspaceId
      PrometheusWorkspaceArn:
        Ref: PrometheusWorkspaceArn
      PrometheusWorkspaceEndpoint:
        Ref: PrometheusWorkspaceEndpoint
      HyperPodObservabilityRole:
        Ref: HyperPodObservabilityRole
      GrafanaRole:
        Ref: GrafanaRole
      StackTemplateUrl:
        Fn::If:
          - CustomBucketCondition
          - Fn::Sub: https://${CustomBucketName}.s3.${AWS::Region}.amazonaws.com/templates/observability-template.yaml
          - Fn::Sub: >-
              https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/observability-template.yaml
      CreateHyperPodObservabilityRole:
        Ref: CreateHyperPodObservabilityRole
      CreateGrafanaRole:
        Ref: CreateGrafanaRole
      CreatePrometheusWorkspace:
        Ref: CreatePrometheusWorkspace
      CreateGrafanaWorkspace:
        Ref: CreateGrafanaWorkspace
    DependsOn:
      - ObservabilityCustomResourceFunction
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/ObservabilityCustomResource
    Condition: EnableObservabilityFeatureCondition
  DataScientistSetupStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::If:
          - CustomBucketCondition
          - Fn::Sub: https://${CustomBucketName}.s3.${AWS::Region}.amazonaws.com/templates/data-scientist-setup-template.yaml
          - Fn::Sub: >-
              https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/data-scientist-setup-template.yaml
      Parameters:
        ResourceNamePrefix:
          Ref: ResourceNamePrefix
        EKSClusterName:
          Fn::If:
            - CreateEKSClusterStackCondition
            - Fn::GetAtt:
                - EKSClusterStack
                - Outputs.EKSClusterName
            - Ref: EKSClusterName
        HPClusterArn:
          Fn::If:
            - CreateHyperPodClusterStackCondition
            - Fn::GetAtt:
                - HyperPodClusterStack
                - Outputs.HyperPodClusterArn
            - ''
        DataScientistRole1:
          Ref: DataScientistRole1
        DataScientistRole1Namespaces:
          Ref: DataScientistRole1Namespaces
        DataScientistRole2:
          Ref: DataScientistRole2
        DataScientistRole2Namespaces:
          Ref: DataScientistRole2Namespaces
        DataScientistRole3:
          Ref: DataScientistRole3
        DataScientistRole3Namespaces:
          Ref: DataScientistRole3Namespaces
        DataScientistRole4:
          Ref: DataScientistRole4
        DataScientistRole4Namespaces:
          Ref: DataScientistRole4Namespaces
        DataScientistRole5:
          Ref: DataScientistRole5
        DataScientistRole5Namespaces:
          Ref: DataScientistRole5Namespaces
        DataScientistRole6:
          Ref: DataScientistRole6
        DataScientistRole6Namespaces:
          Ref: DataScientistRole6Namespaces
        DataScientistRole7:
          Ref: DataScientistRole7
        DataScientistRole7Namespaces:
          Ref: DataScientistRole7Namespaces
        DataScientistRole8:
          Ref: DataScientistRole8
        DataScientistRole8Namespaces:
          Ref: DataScientistRole8Namespaces
        DataScientistRole9:
          Ref: DataScientistRole9
        DataScientistRole9Namespaces:
          Ref: DataScientistRole9Namespaces
        DataScientistRole10:
          Ref: DataScientistRole10
        DataScientistRole10Namespaces:
          Ref: DataScientistRole10Namespaces
        CustomResourceS3Bucket:
          Fn::If:
            - CustomBucketCondition
            - Ref: CustomBucketName
            - Fn::Sub: aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}
    DependsOn:
      - HyperPodClusterStack
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/DataScientistSetupStack
    Condition: DataScientistSetupCondition
  HPTrainingOperatorMainStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        Fn::If:
          - CustomBucketCondition
          - Fn::Sub: https://${CustomBucketName}.s3.${AWS::Region}.amazonaws.com/templates/hpto-main-stack-template.yaml
          - Fn::Sub: >-
              https://aws-sagemaker-hyperpod-cluster-setup-${AWS::Region}-${Stage}.s3.${AWS::Region}.amazonaws.com/templates/hpto-main-stack-template.yaml
      Parameters:
        ResourceNamePrefix:
          Ref: ResourceNamePrefix
        Stage:
          Ref: Stage
        CustomBucketName:
          Ref: CustomBucketName
        EKSClusterName:
          Fn::If:
            - CreateEKSClusterStackCondition
            - Fn::GetAtt:
                - EKSClusterStack
                - Outputs.EKSClusterName
            - Ref: EKSClusterName
    DependsOn:
      - CertManagerStack
      - EKSClusterStack
      - HyperPodClusterStack
    Metadata:
      aws:cdk:path: MainEksBasedCfnTemplate/HPTrainingOperatorMainStack
    Condition: EnableHPTrainingOperatorFeatureCondition
Outputs:
  OutputVpcId:
    Value:
      Fn::GetAtt:
        - VPCStack
        - Outputs.VpcId
    Condition: CreateVPCStackCondition
  OutputPrivateSubnetIds:
    Value:
      Fn::GetAtt:
        - PrivateSubnetStack
        - Outputs.PrivateSubnetIds
    Condition: CreatePrivateSubnetStackCondition
  OutputSecurityGroupId:
    Value:
      Fn::GetAtt:
        - SecurityGroupStack
        - Outputs.SecurityGroupId
    Condition: CreateSecurityGroupStackCondition
  OutputEKSClusterArn:
    Value:
      Fn::GetAtt:
        - EKSClusterStack
        - Outputs.EKSClusterArn
    Condition: CreateEKSClusterStackCondition
  OutputEKSClusterName:
    Value:
      Fn::GetAtt:
        - EKSClusterStack
        - Outputs.EKSClusterName
    Condition: CreateEKSClusterStackCondition
  OutputSageMakerIAMRoleArn:
    Value:
      Fn::GetAtt:
        - SageMakerIAMRoleStack
        - Outputs.SageMakerIAMRoleArn
    Condition: CreateSageMakerIAMRoleStackCondition
  OutputInfOperatorIAMRoleArn:
    Value:
      Fn::GetAtt:
        - InferenceOperatorMainStack
        - Outputs.InfOperatorIAMRoleArn
    Condition: EnableHPInferenceFeatureCondition
  OutputInfOperatorIAMRoleName:
    Value:
      Fn::GetAtt:
        - InferenceOperatorMainStack
        - Outputs.InfOperatorIAMRoleName
    Condition: EnableHPInferenceFeatureCondition
  OutputS3BucketName:
    Value:
      Fn::GetAtt:
        - S3BucketStack
        - Outputs.S3BucketName
    Condition: CreateS3BucketStackCondition
  OutputHyperPodClusterName:
    Value:
      Fn::GetAtt:
        - HyperPodClusterStack
        - Outputs.HyperPodClusterName
    Condition: CreateHyperPodClusterStackCondition
  OutputHyperPodClusterArn:
    Value:
      Fn::GetAtt:
        - HyperPodClusterStack
        - Outputs.HyperPodClusterArn
    Condition: CreateHyperPodClusterStackCondition
  OutputObservabilityStackId:
    Value:
      Fn::GetAtt:
        - ObservabilityCustomResource
        - StackId
    Condition: EnableObservabilityFeatureCondition
  OutputHPTOIAMRoleArn:
    Value:
      Fn::GetAtt:
        - HPTrainingOperatorMainStack
        - Outputs.HPTOIAMRoleArn
    Condition: EnableHPTrainingOperatorFeatureCondition
  OutputHPTOIAMRoleName:
    Value:
      Fn::GetAtt:
        - HPTrainingOperatorMainStack
        - Outputs.HPTOIAMRoleName
    Condition: EnableHPTrainingOperatorFeatureCondition
