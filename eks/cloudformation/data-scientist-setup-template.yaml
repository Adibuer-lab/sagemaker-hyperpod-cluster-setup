Description: Data Scientist Setup Stack for HyperPod
Parameters:
  ResourceNamePrefix:
    Type: String
    Default: sagemaker-hyperpod-eks
    Description: Prefix to be used for all resources created by this template.
  EKSClusterName:
    Type: String
    Description: The name of the EKS cluster.
  HPClusterArn:
    Type: String
    Description: ARN of the HyperPod cluster.
  DataScientistRole1:
    Type: String
    Default: ''
    Description: >-
      First HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole1Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole1. Model deployment permissions will be scoped
      to these namespaces. (optional)
  DataScientistRole2:
    Type: String
    Default: ''
    Description: >-
      Second HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole2Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole2. Model deployment permissions will be scoped
      to these namespaces. (optional)
  DataScientistRole3:
    Type: String
    Default: ''
    Description: >-
      Third HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole3Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole3. Model deployment permissions will be scoped
      to these namespaces. (optional)
  DataScientistRole4:
    Type: String
    Default: ''
    Description: >-
      Fourth HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole4Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole4. Model deployment permissions will be scoped
      to these namespaces. (optional)
  DataScientistRole5:
    Type: String
    Default: ''
    Description: >-
      Fifth HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole5Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole5. Model deployment permissions will be scoped
      to these namespaces. (optional)
  DataScientistRole6:
    Type: String
    Default: ''
    Description: >-
      Sixth HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole6Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole6. Model deployment permissions will be scoped
      to these namespaces. (optional)
  DataScientistRole7:
    Type: String
    Default: ''
    Description: >-
      Seventh HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole7Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole7. Model deployment permissions will be scoped
      to these namespaces. (optional)
  DataScientistRole8:
    Type: String
    Default: ''
    Description: >-
      Eighth HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole8Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole8. Model deployment permissions will be scoped
      to these namespaces. (optional)
  DataScientistRole9:
    Type: String
    Default: ''
    Description: >-
      Ninth HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole9Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole9. Model deployment permissions will be scoped
      to these namespaces. (optional)
  DataScientistRole10:
    Type: String
    Default: ''
    Description: >-
      Tenth HyperPod Data Scientist IAM role name. Model deployment permissions will be scoped to the specified
      namespaces. (optional)
  DataScientistRole10Namespaces:
    Type: String
    Default: ''
    Description: >-
      Comma-separated list of Kubernetes namespaces for DataScientistRole10. Model deployment permissions will be scoped
      to these namespaces. (optional)
  CustomResourceS3Bucket:
    Type: String
    Default: aws-sagemaker-hyperpod-cluster-setup-us-east-2-prod
    Description: The name of the S3 bucket containing the custom resource.
  LayerS3Key:
    Type: String
    Default: resources/artifacts/ds-setup-lambda-layer.zip
    Description: The S3 key for the lambda layer zip file.
  FunctionS3Key:
    Type: String
    Default: resources/artifacts/ds-setup-lambda-function.zip
    Description: The S3 key for the lambda function zip file.
Conditions:
  Role1ProvidedCondition:
    Fn::Not:
      - Fn::Equals:
          - Ref: DataScientistRole1
          - ''
  Role2ProvidedCondition:
    Fn::Not:
      - Fn::Equals:
          - Ref: DataScientistRole2
          - ''
  Role3ProvidedCondition:
    Fn::Not:
      - Fn::Equals:
          - Ref: DataScientistRole3
          - ''
  Role4ProvidedCondition:
    Fn::Not:
      - Fn::Equals:
          - Ref: DataScientistRole4
          - ''
  Role5ProvidedCondition:
    Fn::Not:
      - Fn::Equals:
          - Ref: DataScientistRole5
          - ''
  Role6ProvidedCondition:
    Fn::Not:
      - Fn::Equals:
          - Ref: DataScientistRole6
          - ''
  Role7ProvidedCondition:
    Fn::Not:
      - Fn::Equals:
          - Ref: DataScientistRole7
          - ''
  Role8ProvidedCondition:
    Fn::Not:
      - Fn::Equals:
          - Ref: DataScientistRole8
          - ''
  Role9ProvidedCondition:
    Fn::Not:
      - Fn::Equals:
          - Ref: DataScientistRole9
          - ''
  Role10ProvidedCondition:
    Fn::Not:
      - Fn::Equals:
          - Ref: DataScientistRole10
          - ''
Resources:
  DataScientistSetupCustomResourceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: 2012-10-17
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - eks:DescribeCluster
                Resource:
                  Fn::Sub: arn:aws:eks:${AWS::Region}:${AWS::AccountId}:cluster/${EKSClusterName}
          PolicyName:
            Fn::Sub: ${ResourceNamePrefix}-DataScientistSetup-EKSClusterAccess
        - PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - eks:CreateAccessEntry
                  - eks:DescribeAccessEntry
                  - eks:ListAccessEntries
                  - eks:DeleteAccessEntry
                Resource:
                  - Fn::Sub: arn:aws:eks:${AWS::Region}:${AWS::AccountId}:cluster/${EKSClusterName}
                  - Fn::If:
                      - Role1ProvidedCondition
                      - Fn::Sub: >-
                          arn:aws:eks:${AWS::Region}:${AWS::AccountId}:access-entry/${EKSClusterName}/role/${AWS::AccountId}/${DataScientistRole1}/*
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role2ProvidedCondition
                      - Fn::Sub: >-
                          arn:aws:eks:${AWS::Region}:${AWS::AccountId}:access-entry/${EKSClusterName}/role/${AWS::AccountId}/${DataScientistRole2}/*
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role3ProvidedCondition
                      - Fn::Sub: >-
                          arn:aws:eks:${AWS::Region}:${AWS::AccountId}:access-entry/${EKSClusterName}/role/${AWS::AccountId}/${DataScientistRole3}/*
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role4ProvidedCondition
                      - Fn::Sub: >-
                          arn:aws:eks:${AWS::Region}:${AWS::AccountId}:access-entry/${EKSClusterName}/role/${AWS::AccountId}/${DataScientistRole4}/*
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role5ProvidedCondition
                      - Fn::Sub: >-
                          arn:aws:eks:${AWS::Region}:${AWS::AccountId}:access-entry/${EKSClusterName}/role/${AWS::AccountId}/${DataScientistRole5}/*
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role6ProvidedCondition
                      - Fn::Sub: >-
                          arn:aws:eks:${AWS::Region}:${AWS::AccountId}:access-entry/${EKSClusterName}/role/${AWS::AccountId}/${DataScientistRole6}/*
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role7ProvidedCondition
                      - Fn::Sub: >-
                          arn:aws:eks:${AWS::Region}:${AWS::AccountId}:access-entry/${EKSClusterName}/role/${AWS::AccountId}/${DataScientistRole7}/*
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role8ProvidedCondition
                      - Fn::Sub: >-
                          arn:aws:eks:${AWS::Region}:${AWS::AccountId}:access-entry/${EKSClusterName}/role/${AWS::AccountId}/${DataScientistRole8}/*
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role9ProvidedCondition
                      - Fn::Sub: >-
                          arn:aws:eks:${AWS::Region}:${AWS::AccountId}:access-entry/${EKSClusterName}/role/${AWS::AccountId}/${DataScientistRole9}/*
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role10ProvidedCondition
                      - Fn::Sub: >-
                          arn:aws:eks:${AWS::Region}:${AWS::AccountId}:access-entry/${EKSClusterName}/role/${AWS::AccountId}/${DataScientistRole10}/*
                      - Ref: AWS::NoValue
          PolicyName:
            Fn::Sub: ${ResourceNamePrefix}-DataScientistSetup-EKSAccessEntryAccess
        - PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - iam:GetRole
                  - iam:PutRolePolicy
                  - iam:DeleteRolePolicy
                  - iam:ListRolePolicies
                Resource:
                  - Fn::If:
                      - Role1ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/${DataScientistRole1}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role1ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/*/${DataScientistRole1}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role2ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/${DataScientistRole2}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role2ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/*/${DataScientistRole2}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role3ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/${DataScientistRole3}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role3ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/*/${DataScientistRole3}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role4ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/${DataScientistRole4}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role4ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/*/${DataScientistRole4}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role5ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/${DataScientistRole5}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role5ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/*/${DataScientistRole5}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role6ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/${DataScientistRole6}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role6ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/*/${DataScientistRole6}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role7ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/${DataScientistRole7}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role7ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/*/${DataScientistRole7}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role8ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/${DataScientistRole8}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role8ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/*/${DataScientistRole8}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role9ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/${DataScientistRole9}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role9ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/*/${DataScientistRole9}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role10ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/${DataScientistRole10}
                      - Ref: AWS::NoValue
                  - Fn::If:
                      - Role10ProvidedCondition
                      - Fn::Sub: arn:aws:iam::${AWS::AccountId}:role/*/${DataScientistRole10}
                      - Ref: AWS::NoValue
          PolicyName:
            Fn::Sub: ${ResourceNamePrefix}-DataScientistSetup-IAMAccess
    Metadata:
      aws:cdk:path: DataScientistSetupCfnTemplate/DataScientistSetupCustomResourceRole
  DataScientistSetupCustomResourceAccessEntry:
    Type: AWS::EKS::AccessEntry
    Properties:
      AccessPolicies:
        - AccessScope:
            Type: cluster
          PolicyArn: arn:aws:eks::aws:cluster-access-policy/AmazonEKSClusterAdminPolicy
      ClusterName:
        Ref: EKSClusterName
      PrincipalArn:
        Fn::GetAtt:
          - DataScientistSetupCustomResourceRole
          - Arn
    Metadata:
      aws:cdk:path: DataScientistSetupCfnTemplate/DataScientistSetupCustomResourceAccessEntry
  DataScientistSetupCustomResourceLayer:
    Type: AWS::Lambda::LayerVersion
    Properties:
      CompatibleArchitectures:
        - x86_64
      CompatibleRuntimes:
        - python3.9
        - python3.10
        - python3.11
        - python3.12
      Content:
        S3Bucket:
          Ref: CustomResourceS3Bucket
        S3Key:
          Ref: LayerS3Key
      Description: Lambda Layer for kubectl and AWS CLI tools
      LayerName:
        Fn::Sub: ${ResourceNamePrefix}-ds-setup-layer
    Metadata:
      aws:cdk:path: DataScientistSetupCfnTemplate/DataScientistSetupCustomResourceLayer
  DataScientistSetupCustomResourceFunction:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Ref: CustomResourceS3Bucket
        S3Key:
          Ref: FunctionS3Key
      Environment:
        Variables:
          CLUSTER_NAME:
            Ref: EKSClusterName
          REGION:
            Ref: AWS::Region
          ACCOUNT_ID:
            Ref: AWS::AccountId
          HYPERPOD_CLUSTER_ARN:
            Ref: HPClusterArn
          EKS_CLUSTER_ARN:
            Fn::Sub: arn:aws:eks:${AWS::Region}:${AWS::AccountId}:cluster/${EKSClusterName}
          DATA_SCIENTIST_ROLE_1:
            Ref: DataScientistRole1
          DATA_SCIENTIST_ROLE_1_NAMESPACES:
            Ref: DataScientistRole1Namespaces
          DATA_SCIENTIST_ROLE_2:
            Ref: DataScientistRole2
          DATA_SCIENTIST_ROLE_2_NAMESPACES:
            Ref: DataScientistRole2Namespaces
          DATA_SCIENTIST_ROLE_3:
            Ref: DataScientistRole3
          DATA_SCIENTIST_ROLE_3_NAMESPACES:
            Ref: DataScientistRole3Namespaces
          DATA_SCIENTIST_ROLE_4:
            Ref: DataScientistRole4
          DATA_SCIENTIST_ROLE_4_NAMESPACES:
            Ref: DataScientistRole4Namespaces
          DATA_SCIENTIST_ROLE_5:
            Ref: DataScientistRole5
          DATA_SCIENTIST_ROLE_5_NAMESPACES:
            Ref: DataScientistRole5Namespaces
          DATA_SCIENTIST_ROLE_6:
            Ref: DataScientistRole6
          DATA_SCIENTIST_ROLE_6_NAMESPACES:
            Ref: DataScientistRole6Namespaces
          DATA_SCIENTIST_ROLE_7:
            Ref: DataScientistRole7
          DATA_SCIENTIST_ROLE_7_NAMESPACES:
            Ref: DataScientistRole7Namespaces
          DATA_SCIENTIST_ROLE_8:
            Ref: DataScientistRole8
          DATA_SCIENTIST_ROLE_8_NAMESPACES:
            Ref: DataScientistRole8Namespaces
          DATA_SCIENTIST_ROLE_9:
            Ref: DataScientistRole9
          DATA_SCIENTIST_ROLE_9_NAMESPACES:
            Ref: DataScientistRole9Namespaces
          DATA_SCIENTIST_ROLE_10:
            Ref: DataScientistRole10
          DATA_SCIENTIST_ROLE_10_NAMESPACES:
            Ref: DataScientistRole10Namespaces
          PATH: /opt/python/bin:/var/lang/bin:/usr/local/bin:/usr/bin/:/bin
          KUBECONFIG: /tmp/.kube/config
          LD_LIBRARY_PATH: /opt/python/lib
      FunctionName:
        Fn::Sub: ${ResourceNamePrefix}-ds-setup
      Handler: lambda_function.lambda_handler
      Layers:
        - Ref: DataScientistSetupCustomResourceLayer
      Role:
        Fn::GetAtt:
          - DataScientistSetupCustomResourceRole
          - Arn
      Runtime: python3.12
      Timeout: 600
    DependsOn:
      - DataScientistSetupCustomResourceAccessEntry
    Metadata:
      aws:cdk:path: DataScientistSetupCfnTemplate/DataScientistSetupCustomResourceFunction
  DataScientistSetupCustomResource:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - DataScientistSetupCustomResourceFunction
          - Arn
    Metadata:
      aws:cdk:path: DataScientistSetupCfnTemplate/DataScientistSetupCustomResource
Outputs:
  DataScientistSetupComplete:
    Description: Indicates data scientist setup is complete
    Value: DataScientistSetupComplete
